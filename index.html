<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareApp - Firebase SPA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom gradient for buttons and active elements */
        .gradient-bg {
            background: linear-gradient(90deg, #A78BFA 0%, #8B5CF6 100%);
        }
        /* Style for active navigation button */
        .nav-button.active {
            color: #8B5CF6; /* Violet-600 */
        }
        /* Ensure the app container uses the full viewport height */
        #app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="transition-colors duration-300">

    <div id="app" class="relative">
        </div>

<script type="module">
    // =================================================================
    // 1. FIREBASE & CORE IMPORTS
    // =================================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword, 
        signOut, 
        GoogleAuthProvider, 
        signInWithPopup,
        signInAnonymously,
        signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        query, 
        onSnapshot, 
        updateDoc, 
        doc, 
        deleteDoc, 
        serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // =================================================================
    // 2. CONFIGURATION & INITIALIZATION
    // =================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyAUL74mqVCIY1MMclrRhdVbY_VyP4lgQpY",
        authDomain: "waiappstore.firebaseapp.com",
        projectId: "waiappstore",
        storageBucket: "waiappstore.firebasestorage.app",
        messagingSenderId: "161610339691",
        appId: "1:161610339691:web:ce59fafb6a21729030682e",
        measurementId: "G-HH95X102MG"
    };

    // Initialize Firebase Services
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global Constants
    const sharedAppsCollectionPath = "sharedApps";
    const adminEmail = "waiyan@example.com"; 
    const initialAuthToken = null; // Set this if using a custom token on load

    // =================================================================
    // 3. GLOBAL STATE & TRANSLATIONS
    // =================================================================

    const translations = {
        en: {
            APP_TITLE: "ShareApp Store", HOME: "Home", UPLOAD: "Upload", PROFILE: "Profile", SETTINGS: "Settings", ADMIN: "Admin", SIGN_IN: "Sign In", SIGN_UP: "Sign Up", SIGN_OUT: "Sign Out", PASSWORD: "Password", EMAIL: "Email", NO_ACCOUNT: "Need an account? Sign Up", ACCOUNT_LOGIN: "Already have an account? Sign In", OR: "OR", SIGN_IN_WITH_GOOGLE: "Sign in with Google", SECRET_CODE: "Your secret code", DEVELOPER_NOTE: "Note: For demonstration, a placeholder account is used. Please use the Google button.", USER_ID: "User ID", NOT_LOGGED_IN: "Not Logged In", PENDING: "Pending Review", APPROVED: "Approved", DOWNLOAD_OR_OPEN: "Get App", NO_APPS_YET: "No approved apps yet. Be the first to submit!", CATEGORIES: "Categories", ALL: "All", GAMES: "Games", SOCIAL: "Social", PRODUCTIVITY: "Productivity", ENTERTAINMENT: "Entertainment", SEARCH_PLACEHOLDER: "Search for apps...", LATEST_APPS: "Latest Shared Apps", SUBMITTED_BY: "Submitted by", SUBMITTED_DATE: "Date", UNKNOWN: "Unknown", APP_INFO: "App Submission", APP_NAME: "App Name", APP_ICON_LINK: "Icon URL", APP_LINK: "App Link (Play Store, etc.)", CATEGORY: "Category", SELECT_CATEGORY: "Select Category", SUBMIT_APP: "Submit App", LOGIN_REQUIRED: "You must sign in to submit an app.", UPLOAD_SUCCESS: "Upload Successful!", UPLOAD_FAILED: "Upload Failed", DATA_FETCH_FAILED: "Failed to fetch data.", SETTING_THEME: "Theme Settings", LIGHT_MODE: "Light Mode", DARK_MODE: "Dark Mode", SETTING_LANGUAGE: "Language", THEME_APPLIED: "Theme applied.", LANGUAGE_APPLIED: "Language applied.", NO_NAME: "No Name", NO_EMAIL: "No Email", EMAIL_PASSWORD: "Email/Password", YOUR_SUBMISSIONS: "Your Submissions", NO_SUBMISSIONS_YET: "You have not submitted any apps yet.", ACCESS_DENIED: "Access Denied", ACCESS_DENIED_MESSAGE: "You do not have administrative privileges.", ADMIN_AREA: "Moderation Queue", SUBMISSIONS: "Submissions", UNAPPROVE: "Unapprove", APPROVE: "Approve", EDIT_APP: "Edit App Details", SAVE_CHANGES: "Save Changes", CANCEL: "Cancel"
        },
        my: {
            APP_TITLE: "ShareApp စတိုး", HOME: "ပင်မ", UPLOAD: "တင်သွင်းရန်", PROFILE: "ပရိုဖိုင်", SETTINGS: "ချိန်ညှိချက်များ", ADMIN: "စီမံခန့်ခွဲသူ", SIGN_IN: "ဝင်ရောက်ရန်", SIGN_UP: "အကောင့်ဖွင့်ရန်", SIGN_OUT: "အကောင့်ထွက်ရန်", PASSWORD: "လျှို့ဝှက်နံပါတ်", EMAIL: "အီးမေးလ်", NO_ACCOUNT: "အကောင့်မရှိဘူးလား။ အကောင့်ဖွင့်ပါ", ACCOUNT_LOGIN: "အကောင့်ရှိပြီးသားလား။ ဝင်ရောက်ပါ", OR: "သို့မဟုတ်", SIGN_IN_WITH_GOOGLE: "Google ဖြင့် ဝင်ရောက်ရန်", SECRET_CODE: "လျှို့ဝှက်နံပါတ်", DEVELOPER_NOTE: "သတိပေးချက်- စမ်းသပ်ရန်အတွက်သာ။ Google ခလုတ်ကို အသုံးပြုပါ။", USER_ID: "အသုံးပြုသူ ID", NOT_LOGGED_IN: "မဝင်ရောက်ရသေးပါ", PENDING: "စောင့်ဆိုင်းဆဲ", APPROVED: "ခွင့်ပြုပြီး", DOWNLOAD_OR_OPEN: "App ရယူရန်", NO_APPS_YET: "ခွင့်ပြုထားသော App မရှိသေးပါ။ ပထမဆုံးတင်သွင်းသူ ဖြစ်ပါစေ။", CATEGORIES: "အမျိုးအစားများ", ALL: "အားလုံး", GAMES: "ဂိမ်း", SOCIAL: "လူမှုကွန်ရက်", PRODUCTIVITY: "အလုပ်စွမ်းဆောင်ရည်", ENTERTAINMENT: "ဖျော်ဖြေရေး", SEARCH_PLACEHOLDER: "Apps များ ရှာဖွေပါ...", LATEST_APPS: "နောက်ဆုံးတင်သွင်းသော Apps များ", SUBMITTED_BY: "တင်သွင်းသူ", SUBMITTED_DATE: "တင်သွင်းသည့်နေ့", UNKNOWN: "မသိရှိရ", APP_INFO: "App အချက်အလက်", APP_NAME: "App အမည်", APP_ICON_LINK: "Icon လင့်ခ်", APP_LINK: "App လင့်ခ် (Play Store, etc.)", CATEGORY: "အမျိုးအစား", SELECT_CATEGORY: "အမျိုးအစား ရွေးပါ", SUBMIT_APP: "App တင်သွင်းရန်", LOGIN_REQUIRED: "App တင်သွင်းရန်အတွက် ဝင်ရောက်ရန်လိုအပ်သည်။", UPLOAD_SUCCESS: "တင်သွင်းမှု အောင်မြင်ပါသည်!", UPLOAD_FAILED: "တင်သွင်းမှု မအောင်မြင်ပါ", DATA_FETCH_FAILED: "ဒေတာရယူရာတွင် အမှားဖြစ်ခဲ့သည်။", SETTING_THEME: "Theme ချိန်ညှိချက်များ", LIGHT_MODE: "အလင်းရောင် Theme", DARK_MODE: "အမှောင် Theme", THEME_APPLIED: "Theme ပြောင်းလဲပြီးပါပြီ။", SETTING_LANGUAGE: "ဘာသာစကား", LANGUAGE_APPLIED: "ဘာသာစကား ပြောင်းလဲပြီးပါပြီ။", NO_NAME: "အမည်မရှိ", NO_EMAIL: "အီးမေးလ်မရှိ", EMAIL_PASSWORD: "အီးမေးလ်/စကားဝှက်", YOUR_SUBMISSIONS: "သင်တင်သွင်းခဲ့သော Apps များ", NO_SUBMISSIONS_YET: "သင် App တစ်ခုမှ တင်သွင်းရသေးခြင်း မရှိပါ။", ACCESS_DENIED: "ဝင်ရောက်ခွင့် မပြုပါ", ACCESS_DENIED_MESSAGE: "သင့်တွင် စီမံခန့်ခွဲသူ အခွင့်အရေး မရှိပါ။", ADMIN_AREA: "စီမံခန့်ခွဲမှု", SUBMISSIONS: "တင်သွင်းမှုများ", UNAPPROVE: "ခွင့်ပြုချက် ရုပ်သိမ်း", APPROVE: "ခွင့်ပြုရန်", EDIT_APP: "App အချက်အလက် ပြင်ဆင်ရန်", SAVE_CHANGES: "အပြောင်းအလဲများ သိမ်းဆည်း", CANCEL: "ပယ်ဖျက်မည်"
        },
        // Thai and Chinese translations were partially included in the original HTML code 
        // but are omitted here for brevity of the combined code block.
        // You would typically include the full translation set here.
    };

    let currentState = {
        view: 'home', // 'home', 'upload', 'profile', 'admin', 'settings', 'login', 'signup'
        authMode: 'login', // 'login' or 'signup'
        user: null, // Firebase user object
        userId: null,
        isAuthReady: false,
        sharedApps: [], // Array of { id, name, link, isApproved, ... }
        theme: localStorage.getItem('theme') || 'light', // 'light' or 'dark'
        language: localStorage.getItem('language') || 'my', // 'my', 'en', 'th', 'zh'
        message: null,
        error: null,
        editingAppId: null, // ID of the app currently being edited in admin view
    };

    // =================================================================
    // 4. CORE FUNCTIONS (Included from your original parts)
    // =================================================================

    /** Translation Function */
    function T(key) {
        return translations[currentState.language]?.[key] || translations['en'][key] || key;
    }

    /** Theme Management */
    function updateTheme(theme) {
        document.body.classList.remove('bg-white', 'bg-gray-900');
        if (theme === 'dark') {
            document.body.classList.add('bg-gray-900');
            document.documentElement.classList.add('dark');
        } else {
            document.body.classList.add('bg-white');
            document.documentElement.classList.remove('dark');
        }
        localStorage.setItem('theme', theme);
    }

    /** State Update and Re-render */
    function updateState(newState) {
        Object.assign(currentState, newState);
        renderApp();
        updateTheme(currentState.theme);
    }

    /** Message Display */
    function showMessage(msg, isError = false) {
        updateState({ message: isError ? null : msg, error: isError ? msg : null });
        setTimeout(() => updateState({ message: null, error: null }), 3000);
    }

    /** Icon Utility */
    function icon(name, classes = 'w-6 h-6 mr-2') {
        return `<i data-lucide="${name}" class="${classes}"></i>`;
    }

    /** Admin Check */
    function isAdmin() {
        return currentState.user && currentState.user.email === adminEmail;
    }

    // --- Auth Handlers ---
    async function handleSignIn(email, password) {
        try {
            await signInWithEmailAndPassword(auth, email, password);
            showMessage(T('SIGN_IN') + " " + T('UPLOAD_SUCCESS'));
            updateState({ view: 'home' }); 
        } catch (error) {
            console.error("Sign In Error:", error);
            showMessage(`${T('SIGN_IN')} ${T('UPLOAD_FAILED')}: ${error.message}`, true);
        }
    }

    async function handleSignUp(email, password) {
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showMessage(T('SIGN_UP') + " " + T('UPLOAD_SUCCESS'));
            updateState({ view: 'home' });
        } catch (error) {
            console.error("Sign Up Error:", error);
            showMessage(`${T('SIGN_UP')} ${T('UPLOAD_FAILED')}: ${error.message}`, true);
        }
    }

    async function handleGoogleSignIn() {
        try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
            showMessage("Google " + T('SIGN_IN') + " " + T('UPLOAD_SUCCESS'));
            updateState({ view: 'home' });
        } catch (error) {
            console.error("Google Sign In Error:", error);
            showMessage(`Google ${T('SIGN_IN')} ${T('UPLOAD_FAILED')}: ${error.message}`, true);
        }
    }

    async function handleSignOut() {
        try {
            await signOut(auth);
            showMessage(T('SIGN_OUT') + " " + T('UPLOAD_SUCCESS'));
            updateState({ user: null, view: 'login' });
        } catch (error) {
            console.error("Sign Out Error:", error);
            showMessage(`${T('SIGN_OUT')} ${T('UPLOAD_FAILED')}: ${error.message}`, true);
        }
    }

    // --- Firestore Data Handlers ---

    async function handleAppApproval(appId, isApproved) {
        if (!isAdmin()) return showMessage(T('ACCESS_DENIED'), true);
        try {
            const appRef = doc(db, sharedAppsCollectionPath, appId);
            await updateDoc(appRef, { isApproved: isApproved });
            showMessage(isApproved ? T('APPROVED') : T('PENDING'));
        } catch (error) {
            console.error("Approval Error:", error);
            showMessage(T('UPLOAD_FAILED') + `: ${error.message}`, true);
        }
    }

    async function handleAppDeletion(appId) {
        if (!isAdmin()) return showMessage(T('ACCESS_DENIED'), true);
        if (!confirm(T('CONFIRM_DELETE'))) return; // Assuming CONFIRM_DELETE is available in translations
        try {
            await deleteDoc(doc(db, sharedAppsCollectionPath, appId));
            showMessage(T('UPLOAD_SUCCESS') + " (Deleted)"); 
        } catch (error) {
            console.error("Deletion Error:", error);
            showMessage(T('UPLOAD_FAILED') + `: ${error.message}`, true);
        }
    }

    async function handleAppEdit(appId, name, link, iconLink) {
        if (!isAdmin()) return showMessage(T('ACCESS_DENIED'), true);
        try {
            const appRef = doc(db, sharedAppsCollectionPath, appId);
            await updateDoc(appRef, { name, link, iconLink });
            showMessage(T('SAVE_CHANGES') + " " + T('UPLOAD_SUCCESS'));
            updateState({ editingAppId: null });
        } catch (error) {
            console.error("Edit Error:", error);
            showMessage(T('UPLOAD_FAILED') + `: ${error.message}`, true);
        }
    }

    async function handleAppUpload(name, link, iconLink, category) {
        if (!currentState.user || currentState.userId.includes('anon')) {
            return showMessage(T('LOGIN_REQUIRED'), true);
        }
        try {
            await addDoc(collection(db, sharedAppsCollectionPath), {
                name: name,
                link: link,
                iconLink: iconLink,
                category: category,
                userId: currentState.userId,
                userName: currentState.user?.displayName || currentState.user?.email || 'N/A',
                isApproved: false, // Must be approved by admin
                createdAt: serverTimestamp()
            });
            showMessage(`${T('UPLOAD_SUCCESS')} (${T('PENDING')})`);
            updateState({ view: 'profile' }); // Go to profile to show pending app
        } catch (error) {
            console.error("Upload Error:", error);
            showMessage(`${T('UPLOAD_FAILED')}: ${error.message.substring(0, 50)}...`, true);
        }
    }

    // --- Firestore Realtime Listener ---
    function startAppListener() {
        if (!currentState.isAuthReady) return;

        // Query all documents (approved and unapproved)
        const q = query(collection(db, sharedAppsCollectionPath));

        onSnapshot(q, (snapshot) => {
            const apps = [];
            snapshot.forEach((doc) => {
                apps.push({ id: doc.id, ...doc.data() });
            });
            // Sort by latest first (if createdAt exists)
            apps.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            updateState({ sharedApps: apps });
        }, (error) => {
            console.error("Firestore Listener Error:", error);
            showMessage(T('DATA_FETCH_FAILED'), true);
        });
    }

    // =================================================================
    // 5. UI VIEW COMPONENTS (Included from your original parts)
    // =================================================================

    /** Renders the Header (Top Bar) */
    function renderHeader(titleKey) {
        return `
            <header class="p-4 flex justify-between items-center border-b border-gray-100 sticky top-0 z-10 ${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white'}">
                <button id="menu-toggle-btn" class="p-2 rounded-full ${currentState.theme === 'dark' ? 'hover:bg-gray-700 text-gray-300' : 'hover:bg-gray-100 text-gray-700'}">
                    ${icon('menu')}
                </button>
                
                <h1 class="text-xl font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'}">${T(titleKey)}</h1>
                
                <button id="auth-action-btn" class="p-2 rounded-full gradient-bg shadow-md" data-action="${currentState.user ? 'signout' : 'login'}">
                    ${icon(currentState.user ? 'log-out' : 'user', 'w-4 h-4 text-white')}
                </button>
            </header>
        `;
    }

    /** Renders the Side Menu */
    function renderSideMenu() {
        const userIdDisplay = currentState.userId ? `${T('USER_ID')}: ${currentState.userId}` : T('NOT_LOGGED_IN');
        return `
            <div id="side-menu" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden" data-menu-close>
                <div class="${currentState.theme === 'dark' ? 'bg-gray-700' : 'bg-white'} h-full w-3/4 max-w-xs p-6 shadow-2xl" onclick="event.stopPropagation()">
                    <h2 class="text-2xl font-bold text-violet-600 mb-4">ShareApp</h2>
                    <p class="text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mb-6 break-all">${userIdDisplay}</p>
                    
                    <ul class="space-y-2">
                        <li><a href="#" data-view-target="home" class="flex items-center p-3 text-gray-700 ${currentState.theme === 'dark' ? 'text-gray-200 hover:bg-gray-600' : 'hover:bg-violet-50'} rounded-lg">${icon('home')} <span class="ml-3">${T('HOME')}</span></a></li>
                        <li><a href="#" data-view-target="settings" class="flex items-center p-3 text-gray-700 ${currentState.theme === 'dark' ? 'text-gray-200 hover:bg-gray-600' : 'hover:bg-violet-50'} rounded-lg">${icon('settings')} <span class="ml-3">${T('SETTINGS')}</span></a></li>
                        ${currentState.user ? `
                            <li><a href="#" data-view-target="profile" class="flex items-center p-3 text-gray-700 ${currentState.theme === 'dark' ? 'text-gray-200 hover:bg-gray-600' : 'hover:bg-violet-50'} rounded-lg">${icon('user')} <span class="ml-3">${T('PROFILE')}</span></a></li>
                            <li><a href="#" id="menu-sign-out-btn" class="flex items-center p-3 text-gray-700 ${currentState.theme === 'dark' ? 'text-gray-200 hover:bg-gray-600' : 'hover:bg-violet-50'} rounded-lg">${icon('log-out')} <span class="ml-3">${T('SIGN_OUT')}</span></a></li>
                        ` : `
                            <li><a href="#" data-view-target="login" class="flex items-center p-3 text-gray-700 ${currentState.theme === 'dark' ? 'text-gray-200 hover:bg-gray-600' : 'hover:bg-violet-50'} rounded-lg">${icon('log-in')} <span class="ml-3">${T('SIGN_IN')}</span></a></li>
                        `}
                    </ul>
                </div>
            </div>
        `;
    }


    /** Renders the Home View */
    function renderHome() {
        // Only show approved apps on the home page
        const approvedApps = currentState.sharedApps.filter(app => app.isApproved);

        const appListHtml = approvedApps.length > 0
            ? approvedApps.map(app => `
                <div class="app-link-card ${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-4 shadow-sm rounded-xl border flex flex-col">
                    <div class="flex items-center mb-2">
                        <div class="p-1 rounded-lg mr-3 flex-shrink-0 w-10 h-10 flex items-center justify-center">
                            <img src="${app.iconLink || 'https://placehold.co/40x40/A78BFA/ffffff?text=App'}" 
                                onerror="this.onerror=null; this.src='https://placehold.co/40x40/A78BFA/ffffff?text=App';"
                                alt="App Icon" class="w-full h-full object-contain rounded-md">
                        </div>
                        <div>
                            <p class="text-lg font-semibold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} truncate">${app.name}</p>
                            <p class="text-xs text-violet-500 font-medium">${app.category}</p>
                        </div>
                    </div>
                    <p class="text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mb-3 truncate">${T('SUBMITTED_BY')}: ${app.userName}</p>
                    <a href="${app.link}" target="_blank" class="w-full text-center py-2 px-4 rounded-lg text-white font-medium shadow-md transition duration-150 ease-in-out gradient-bg hover:shadow-lg">
                        ${T('DOWNLOAD_OR_OPEN')}
                    </a>
                    <p class="text-xs ${currentState.theme === 'dark' ? 'text-gray-500' : 'text-gray-400'} mt-2 text-right">${T('SUBMITTED_DATE')}: ${app.createdAt ? new Date(app.createdAt.toDate()).toLocaleDateString(currentState.language === 'th' ? 'th-TH' : 'en-US') : T('UNKNOWN')}</p>
                </div>
            `).join('')
            : `<p class="text-center ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} p-8">${T('NO_APPS_YET')}</p>`;

        return `
            ${renderHeader('APP_TITLE')}
            ${renderSideMenu()}
            <main class="flex-grow p-4 space-y-4 overflow-y-auto">
                
                <div class="relative">
                    <input type="text" placeholder="${T('SEARCH_PLACEHOLDER')}" class="w-full p-3 pl-10 border ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-200 bg-white'} rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition duration-150">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-400'}">${icon('search', 'w-4 h-4')}</span>
                </div>

                <h2 class="text-base font-semibold ${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}">${T('CATEGORIES')}</h2>
                <div class="flex space-x-2 overflow-x-auto pb-2">
                    <span class="bg-violet-500 text-white text-xs font-medium px-3 py-1 rounded-full flex-shrink-0">${T('ALL')}</span>
                    <span class="bg-gray-100 ${currentState.theme === 'dark' ? 'bg-gray-700 text-gray-300' : 'text-gray-700'} text-xs font-medium px-3 py-1 rounded-full flex-shrink-0">${T('GAMES')}</span>
                    <span class="bg-gray-100 ${currentState.theme === 'dark' ? 'bg-gray-700 text-gray-300' : 'text-gray-700'} text-xs font-medium px-3 py-1 rounded-full flex-shrink-0">${T('SOCIAL')}</span>
                    <span class="bg-gray-100 ${currentState.theme === 'dark' ? 'bg-gray-700 text-gray-300' : 'text-gray-700'} text-xs font-medium px-3 py-1 rounded-full flex-shrink-0">${T('PRODUCTIVITY')}</span>
                    <span class="bg-gray-100 ${currentState.theme === 'dark' ? 'bg-gray-700 text-gray-300' : 'text-gray-700'} text-xs font-medium px-3 py-1 rounded-full flex-shrink-0">${T('ENTERTAINMENT')}</span>
                </div>
                
                <h2 class="text-base font-semibold ${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} pt-2">${T('LATEST_APPS')}</h2>
                <div class="space-y-4">
                    ${appListHtml}
                </div>
            </main>
        `;
    }

    /** Renders the Upload App View */
    function renderUpload() {
        return `
            ${renderHeader('UPLOAD')}
            ${renderSideMenu()}
            <main class="flex-grow p-6 overflow-y-auto">
                <form id="upload-form" class="space-y-6 ${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-6 rounded-xl shadow-lg border">
                    <h2 class="text-xl font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-700'}">${T('APP_INFO')}</h2>
                    
                    <div>
                        <label for="appName" class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('APP_NAME')}</label>
                        <input type="text" id="appName" name="appName" required placeholder="ဥပမာ: Amazing Photo Editor" class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}">
                    </div>
                    
                    <div>
                        <label for="appIconLink" class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('APP_ICON_LINK')}</label>
                        <input type="url" id="appIconLink" name="appIconLink" placeholder="ဥပမာ: https://example.com/icon.png (Optional)" class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}">
                    </div>

                    <div>
                        <label for="appLink" class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('APP_LINK')}</label>
                        <input type="url" id="appLink" name="appLink" required placeholder="https://play.google.com/store/..." class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}">
                    </div>

                    <div>
                        <label for="category" class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('CATEGORY')}</label>
                        <select id="category" name="category" required class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300 bg-white'}">
                            <option value="">${T('SELECT_CATEGORY')}</option>
                            <option value="Game">${T('GAMES')}</option>
                            <option value="Social">${T('SOCIAL')}</option>
                            <option value="Productivity">${T('PRODUCTIVITY')}</option>
                            <option value="Entertainment">${T('ENTERTAINMENT')}</option>
                            <option value="Education">ပညာရေး</option>
                        </select>
                    </div>

                    <button type="submit" class="w-full py-3 px-4 rounded-lg text-white font-semibold shadow-lg transition duration-150 ease-in-out gradient-bg hover:opacity-90">
                        <span class="flex items-center justify-center">${icon('upload', 'w-5 h-5 mr-2')} ${T('SUBMIT_APP')}</span>
                    </button>
                    ${!currentState.user || currentState.userId.includes('anon') ? `<p class="text-sm text-red-500 text-center mt-4">${T('LOGIN_REQUIRED')}</p>` : ''}
                </form>
            </main>
        `;
    }
    
    /** Renders the Profile View */
    function renderProfile() {
        const user = currentState.user;
        const displayName = user?.displayName || T('NO_NAME'); 
        const email = user?.email || T('NO_EMAIL');
        const photoURL = user?.photoURL || 'https://placehold.co/100x100/A78BFA/ffffff?text=U';
        const provider = user?.providerData?.[0]?.providerId || T('EMAIL_PASSWORD');

        // Filter apps submitted by the current user
        const userApps = currentState.sharedApps.filter(app => app.userId === currentState.userId);

        const userAppsHtml = userApps.length > 0
            ? userApps.map(app => {
                const statusClass = app.isApproved ? 'bg-green-500' : 'bg-yellow-500';
                const statusText = app.isApproved ? T('APPROVED') : T('PENDING');
                return `
                    <div class="app-link-card ${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-3 shadow-sm rounded-xl border flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="p-1 rounded-lg mr-3 flex-shrink-0 w-10 h-10 flex items-center justify-center">
                                <img src="${app.iconLink || 'https://placehold.co/40x40/A78BFA/ffffff?text=App'}" 
                                    onerror="this.onerror=null; this.src='https://placehold.co/40x40/A78BFA/ffffff?text=App';"
                                    alt="App Icon" class="w-full h-full object-contain rounded-md">
                            </div>
                            <div>
                                <p class="text-sm font-semibold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} truncate">${app.name}</p>
                                <p class="text-xs ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}">${T('CATEGORY')}: ${app.category}</p>
                            </div>
                        </div>
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white ${statusClass}">
                            ${statusText}
                        </span>
                    </div>
                `;
            }).join('')
            : `<p class="text-center ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} p-4">${T('NO_SUBMISSIONS_YET')}</p>`;

        return `
            ${renderHeader('PROFILE')}
            ${renderSideMenu()}
            <main class="flex-grow p-6 overflow-y-auto flex flex-col items-center">
                <div class="${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-6 rounded-xl shadow-lg border w-full max-w-sm text-center">
                    <img src="${photoURL}" onerror="this.onerror=null; this.src='https://placehold.co/100x100/A78BFA/ffffff?text=U';" alt="Profile Image" class="w-24 h-24 rounded-full mx-auto mb-4 object-cover border-4 border-violet-100">
                    
                    <h2 class="text-2xl font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} mb-1">${displayName}</h2>
                    <p class="text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mb-4">${email}</p>
                    <p class="text-xs ${currentState.theme === 'dark' ? 'text-gray-500' : 'text-gray-500'} mb-6">ဝင်ရောက်မှုနည်းလမ်း: ${provider}</p>

                    <button id="profile-sign-out-btn" class="w-full py-2 px-4 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition duration-150 ease-in-out shadow-md">
                        ${icon('log-out', 'w-5 h-5 mr-2 inline-block align-middle')} ${T('SIGN_OUT')}
                    </button>
                    <p class="text-xs ${currentState.theme === 'dark' ? 'text-gray-500' : 'text-gray-400'} mt-4 break-all">${T('USER_ID')}: ${currentState.userId}</p>

                    <h3 class="text-xl font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} mt-6 mb-3 border-t pt-4 ${currentState.theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}">${T('YOUR_SUBMISSIONS')}</h3>
                    <div class="w-full space-y-3">
                        ${userAppsHtml}
                    </div>
                </div>
            </main>
        `;
    }

    /** Renders the Settings View */
    function renderSettings() {
        const langOptions = [
            { code: 'my', name: 'မြန်မာ (Myanmar)' },
            { code: 'en', name: 'English' },
            { code: 'th', name: 'ไทย (Thai)' },
            { code: 'zh', name: '中文 (Chinese)' },
        ];

        return `
            ${renderHeader('SETTINGS')}
            ${renderSideMenu()}
            <main class="flex-grow p-6 overflow-y-auto">
                <div class="${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-6 rounded-xl shadow-lg border space-y-8">
                    <h2 class="text-2xl font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} border-b ${currentState.theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} pb-3">${T('SETTINGS')}</h2>

                    <div>
                        <h3 class="text-xl font-semibold ${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} mb-3">${T('SETTING_THEME')}</h3>
                        <div class="flex space-x-4">
                            <button id="light-mode-btn" class="flex-1 py-3 rounded-lg border-2 ${currentState.theme === 'light' ? 'border-violet-500 bg-violet-50 text-violet-700' : 'border-gray-300'} ${currentState.theme === 'dark' ? 'bg-gray-700 text-gray-300' : 'bg-white'}" data-theme="light">
                                ${icon('sun', 'w-5 h-5 mr-2 inline-block align-middle')} ${T('LIGHT_MODE')}
                            </button>
                            <button id="dark-mode-btn" class="flex-1 py-3 rounded-lg border-2 ${currentState.theme === 'dark' ? 'border-violet-500 bg-violet-700 text-white' : 'border-gray-300'} ${currentState.theme === 'dark' ? 'bg-gray-700 text-gray-300' : 'bg-white'}" data-theme="dark">
                                ${icon('moon', 'w-5 h-5 mr-2 inline-block align-middle')} ${T('DARK_MODE')}
                            </button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold ${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} mb-3">${T('SETTING_LANGUAGE')}</h3>
                        <div id="language-options" class="grid grid-cols-2 gap-3">
                            ${langOptions.map(lang => `
                                <button data-lang="${lang.code}" 
                                    class="py-3 rounded-lg border-2 text-sm transition duration-150 
                                    ${currentState.language === lang.code ? 'border-violet-500 bg-violet-100 text-violet-700' : 'border-gray-300'}
                                    ${currentState.theme === 'dark' ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-white hover:bg-gray-50'}">
                                    ${lang.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </main>
        `;
    }

    /** Renders the Admin View (Moderation) */
    function renderAdmin() {
        const isUserAdmin = isAdmin();

        if (!isUserAdmin) {
             return `
                 ${renderHeader('ADMIN')}
                 ${renderSideMenu()}
                 <main class="flex-grow p-6 overflow-y-auto">
                     <div class="${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-8 rounded-xl shadow-lg border text-center space-y-4">
                         <p class="text-2xl text-red-500 font-bold">${icon('lock', 'w-8 h-8 mx-auto mb-2')} ${T('ACCESS_DENIED')}</p>
                         <p class="${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-600'}">${T('ACCESS_DENIED_MESSAGE')}</p>
                     </div>
                 </main>
             `;
        }
        
        // Admin is logged in, display all submitted apps for moderation
        const allApps = currentState.sharedApps;

        const appListHtml = allApps.length > 0
            ? allApps.map(app => {
                const isEditing = currentState.editingAppId === app.id;
                const statusClass = app.isApproved ? 'bg-green-500' : 'bg-yellow-500';
                const statusText = app.isApproved ? T('APPROVED') : T('PENDING');

                if (isEditing) {
                    return `
                        <div class="app-link-card ${currentState.theme === 'dark' ? 'bg-gray-800' : 'bg-white'} p-4 rounded-xl border-2 border-violet-500 shadow-lg mb-4">
                            <h4 class="text-lg font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} mb-3">${T('EDIT_APP')}</h4>
                            <form data-app-id="${app.id}" class="admin-edit-form space-y-3">
                                <label class="block text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}">${T('APP_NAME')}</label>
                                <input type="text" name="name" value="${app.name}" class="w-full p-2 border rounded-md ${currentState.theme === 'dark' ? 'bg-gray-700 border-gray-600' : 'bg-gray-100 border-gray-300'}" required>
                                
                                <label class="block text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}">${T('APP_LINK')}</label>
                                <input type="url" name="link" value="${app.link}" class="w-full p-2 border rounded-md ${currentState.theme === 'dark' ? 'bg-gray-700 border-gray-600' : 'bg-gray-100 border-gray-300'}" required>
                                
                                <label class="block text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}">${T('APP_ICON_LINK')}</label>
                                <input type="url" name="iconLink" value="${app.iconLink || ''}" placeholder="${T('APP_ICON_LINK')}" class="w-full p-2 border rounded-md ${currentState.theme === 'dark' ? 'bg-gray-700 border-gray-600' : 'bg-gray-100 border-gray-300'}">
                                
                                <div class="flex space-x-2 pt-2">
                                    <button type="submit" class="flex-1 py-2 rounded-lg bg-green-500 text-white font-medium hover:bg-green-600">${T('SAVE_CHANGES')}</button>
                                    <button type="button" data-cancel-edit="${app.id}" class="py-2 px-4 rounded-lg bg-red-500 text-white font-medium hover:bg-red-600">${T('CANCEL')}</button>
                                </div>
                            </form>
                        </div>
                    `;
                }

                return `
                    <div class="app-link-card ${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-4 shadow-sm rounded-xl border mb-4">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center">
                                <div class="p-1 rounded-lg mr-3 flex-shrink-0 w-10 h-10 flex items-center justify-center">
                                    <img src="${app.iconLink || 'https://placehold.co/40x40/A78BFA/ffffff?text=App'}" 
                                        onerror="this.onerror=null; this.src='https://placehold.co/40x40/A78BFA/ffffff?text=App';"
                                        alt="App Icon" class="w-full h-full object-contain rounded-md">
                                </div>
                                <div>
                                    <p class="text-lg font-semibold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} truncate">${app.name}</p>
                                    <p class="text-xs ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}">(${app.category})</p>
                                </div>
                            </div>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                        <p class="text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mt-2 mb-3">
                            ${T('SUBMITTED_BY')}: ${app.userName} | ${T('SUBMITTED_DATE')}: ${app.createdAt ? new Date(app.createdAt.toDate()).toLocaleDateString(currentState.language === 'th' ? 'th-TH' : 'en-US') : T('UNKNOWN')}
                        </p>
                        <div class="flex space-x-2">
                            <button data-approve="${app.id}" class="flex-1 py-2 rounded-lg ${app.isApproved ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white text-sm font-medium transition duration-150">
                                ${app.isApproved ? T('UNAPPROVE') : T('APPROVE')}
                            </button>
                            <button data-edit="${app.id}" class="py-2 px-3 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium transition duration-150">
                                ${icon('edit-2', 'w-4 h-4')}
                            </button>
                            <button data-delete="${app.id}" class="py-2 px-3 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium transition duration-150">
                                ${icon('trash', 'w-4 h-4')}
                            </button>
                        </div>
                    </div>
                `;
            }).join('')
            : `<p class="text-center ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} p-8">${T('NO_APPS_SUBMITTED')}</p>`;

        return `
            ${renderHeader('ADMIN')}
            ${renderSideMenu()}
            <main class="flex-grow p-6 overflow-y-auto">
                <div class="${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-4 rounded-xl shadow-lg border space-y-4">
                    <h3 class="text-xl font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} mb-3">${T('ADMIN_AREA')} (${allApps.length} ${T('SUBMISSIONS')})</h3>
                    <div class="space-y-4">
                        ${appListHtml}
                    </div>
                </div>
            </main>
        `;
    }

    /** Renders the Login/Signup View */
    function renderAuthView() {
        const isLogin = currentState.authMode === 'login';
        const title = isLogin ? T('SIGN_IN') : T('SIGN_UP');
        const actionButtonText = isLogin ? T('SIGN_IN') : T('SIGN_UP');

        return `
            ${renderHeader(isLogin ? 'SIGN_IN' : 'SIGN_UP')}
            ${renderSideMenu()}
            <main class="flex-grow p-6 overflow-y-auto flex flex-col justify-center">
                <div class="${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-8 rounded-xl shadow-2xl border w-full max-w-sm mx-auto space-y-6">
                    
                    <h2 class="text-3xl font-extrabold text-center text-violet-700">${title}</h2>

                    <p class="text-sm text-center ${currentState.theme === 'dark' ? 'text-yellow-400 bg-gray-700' : 'text-yellow-700 bg-yellow-100'} p-2 rounded-lg">${T('DEVELOPER_NOTE')}</p>

                    <form id="auth-form" class="space-y-4">
                        <div>
                            <label for="auth-email" class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('EMAIL')}</label>
                            <input type="email" id="auth-email" required class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}" placeholder="user@example.com">
                        </div>
                        <div>
                            <label for="auth-password" class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('PASSWORD')}</label>
                            <input type="password" id="auth-password" required class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}" placeholder="${T('SECRET_CODE')}">
                        </div>

                        <button type="submit" class="w-full py-3 px-4 rounded-lg text-white font-semibold shadow-md gradient-bg hover:opacity-90 transition duration-150 ease-in-out">
                            ${actionButtonText}
                        </button>
                    </form>

                    <div class="flex items-center justify-center">
                        <div class="flex-grow border-t ${currentState.theme === 'dark' ? 'border-gray-600' : 'border-gray-200'}"></div>
                        <span class="flex-shrink mx-4 ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-400'} text-sm">${T('OR')}</span>
                        <div class="flex-grow border-t ${currentState.theme === 'dark' ? 'border-gray-600' : 'border-gray-200'}"></div>
                    </div>
                    
                    <button id="google-sign-in-btn" class="w-full py-3 px-4 rounded-lg ${currentState.theme === 'dark' ? 'bg-gray-700 text-white border-gray-600 hover:bg-gray-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'} font-semibold border shadow-sm transition duration-150 ease-in-out flex items-center justify-center">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/2048px-Google_%22G%22_logo.svg.png" alt="Google logo" class="w-5 h-5 mr-3">
                        ${T('SIGN_IN_WITH_GOOGLE')}
                    </button>

                    <button id="auth-mode-toggle-btn" class="w-full text-sm text-violet-600 font-medium hover:text-violet-500 mt-4">
                        ${isLogin ? T('NO_ACCOUNT') : T('ACCOUNT_LOGIN')}
                    </button>
                </div>
            </main>
        `;
    }

    /** Renders the persistent bottom navigation bar */
    function renderNavBar() {
        const navItems = [
            { id: 'home', labelKey: 'HOME', iconName: 'home' },
            { id: 'upload', labelKey: 'UPLOAD', iconName: 'upload' },
            { id: 'profile', labelKey: 'PROFILE', iconName: 'user' },
            { id: 'admin', labelKey: 'ADMIN', iconName: 'lock' },
            { id: 'settings', labelKey: 'SETTINGS', iconName: 'settings' },
        ];

        const navHtml = navItems.map(item => `
            <button data-view-target="${item.id}" 
                    class="nav-button p-2 flex flex-col items-center justify-center text-xs transition duration-150 ${currentState.view === item.id ? 'active' : ''}">
                ${icon(item.iconName, 'w-5 h-5 mb-1')}
                <span class="mt-0">${T(item.labelKey)}</span>
            </button>
        `).join('');

        return `
            <nav class="sticky bottom-0 w-full ${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border-t shadow-lg p-2 flex justify-around flex-shrink-0 z-10">
                ${navHtml}
            </nav>
        `;
    }

    /** Main Render Function */
    function renderApp() {
        const appDiv = document.getElementById('app');
        if (!appDiv) return;

        let contentHtml;
        const currentView = currentState.user ? currentState.view : 'login'; // Force login if not authenticated

        switch (currentView) {
            case 'home':
                contentHtml = renderHome();
                break;
            case 'upload':
                contentHtml = renderUpload();
                break;
            case 'profile':
                contentHtml = renderProfile();
                break;
            case 'admin':
                contentHtml = renderAdmin();
                break;
            case 'settings':
                contentHtml = renderSettings();
                break;
            case 'login':
            case 'signup':
            default:
                contentHtml = renderAuthView();
                break;
        }

        const messageBanner = (currentState.error || currentState.message) ? `
            <div class="p-3 text-sm text-center fixed top-0 left-0 right-0 z-50 transition-transform duration-300 ${currentState.error ? 'bg-red-500' : 'bg-green-500'} text-white shadow-lg">
                ${currentState.error || currentState.message}
            </div>
        ` : '';

        // Combine all parts
        appDiv.innerHTML = messageBanner + contentHtml + (currentState.user ? renderNavBar() : '');

        // Initialize Lucide icons
        lucide.createIcons();

        // Attach event listeners after rendering
        attachEventListeners(currentView);
    }

    // =================================================================
    // 6. EVENT LISTENERS & INITIALIZATION LOGIC (Included from your final part)
    // =================================================================

    /** Attach Event Listeners */
    function attachEventListeners(currentView) {
        // --- 1. General Navigation and Header Listeners (Common to all views) ---
        const sideMenu = document.getElementById('side-menu');

        // Menu Toggle Button
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        if (menuToggleBtn && sideMenu) {
            menuToggleBtn.addEventListener('click', () => sideMenu.classList.remove('hidden'));
        }

        // Side Menu Overlay Close Listener
        if (sideMenu) {
            sideMenu.addEventListener('click', (e) => {
                if (e.target.hasAttribute('data-menu-close')) {
                    sideMenu.classList.add('hidden'); // Close menu after selection
                }
            });
        }
        
        // Auth/Sign Out Button in Header
        const authActionBtn = document.getElementById('auth-action-btn');
        if (authActionBtn) {
            authActionBtn.addEventListener('click', () => {
                const action = authActionBtn.getAttribute('data-action');
                if (action === 'signout') {
                    handleSignOut();
                } else if (action === 'login') {
                    updateState({ view: 'login' });
                }
            });
        }
        
        // Navigation Links (Side Menu and Nav Bar) - uses data-view-target attribute
        document.querySelectorAll('[data-view-target]').forEach(element => {
            element.addEventListener('click', (e) => {
                e.preventDefault();
                const targetView = element.getAttribute('data-view-target');
                updateState({ view: targetView });
                if (sideMenu) {
                    sideMenu.classList.add('hidden'); // Close menu after selection
                }
            });
        });

        // Sign Out from Side Menu 
        const menuSignOutBtn = document.getElementById('menu-sign-out-btn');
        if (menuSignOutBtn) {
            menuSignOutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                handleSignOut();
                if (sideMenu) {
                    sideMenu.classList.add('hidden');
                }
            });
        }
        
        // --- 2. View-Specific Listeners ---
        if (currentView === 'upload') {
            const uploadForm = document.getElementById('upload-form');
            if (uploadForm) {
                uploadForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const appName = document.getElementById('appName').value;
                    const appLink = document.getElementById('appLink').value;
                    const appIconLink = document.getElementById('appIconLink').value;
                    const category = document.getElementById('category').value;
                    await handleAppUpload(appName, appLink, appIconLink, category);
                };
            }
        } else if (currentView === 'profile') {
            const profileSignOutBtn = document.getElementById('profile-sign-out-btn');
            if (profileSignOutBtn) {
                profileSignOutBtn.addEventListener('click', handleSignOut);
            }
        } else if (currentView === 'login' || currentView === 'signup') {
            const authForm = document.getElementById('auth-form');
            if (authForm) {
                authForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('auth-email').value;
                    const password = document.getElementById('auth-password').value;
                    if (currentState.authMode === 'login') {
                        await handleSignIn(email, password);
                    } else {
                        await handleSignUp(email, password);
                    }
                };
            }
            
            // Google Sign-In button
            const googleBtn = document.getElementById('google-sign-in-btn');
            if (googleBtn) {
                googleBtn.onclick = handleGoogleSignIn;
            }

            // Auth Mode Toggle button
            const authModeToggleBtn = document.getElementById('auth-mode-toggle-btn'); 
            if (authModeToggleBtn) {
                authModeToggleBtn.addEventListener('click', () => {
                    const isLogin = currentState.authMode === 'login';
                    updateState({ authMode: isLogin ? 'signup' : 'login' });
                });
            }
        } else if (currentView === 'settings') {
            // Theme buttons
            document.getElementById('light-mode-btn')?.addEventListener('click', () => {
                updateState({ theme: 'light' });
                showMessage(T('THEME_APPLIED'));
            });
            document.getElementById('dark-mode-btn')?.addEventListener('click', () => {
                updateState({ theme: 'dark' });
                showMessage(T('THEME_APPLIED'));
            });

            // Language buttons
            document.getElementById('language-options')?.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const lang = e.currentTarget.getAttribute('data-lang');
                    updateState({ language: lang });
                    showMessage(T('LANGUAGE_APPLIED'));
                });
            });
        } else if (currentView === 'admin') {
            // Admin Moderation Listeners
            document.querySelectorAll('[data-approve]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appId = e.currentTarget.getAttribute('data-approve');
                    const app = currentState.sharedApps.find(a => a.id === appId);
                    if (app) {
                        handleAppApproval(appId, !app.isApproved); // Toggle approval
                    }
                });
            });

            document.querySelectorAll('[data-delete]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appId = e.currentTarget.getAttribute('data-delete');
                    // In a real app, you would use a custom modal for confirmation here.
                    handleAppDeletion(appId);
                });
            });

            document.querySelectorAll('[data-edit]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appId = e.currentTarget.getAttribute('data-edit');
                    updateState({ editingAppId: appId });
                });
            });

            document.querySelectorAll('[data-cancel-edit]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    updateState({ editingAppId: null });
                });
            });
            
            document.querySelectorAll('.admin-edit-form').forEach(form => {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const appId = form.getAttribute('data-app-id');
                    const name = form.name.value;
                    const link = form.link.value;
                    const iconLink = form.iconLink.value;
                    await handleAppEdit(appId, name, link, iconLink);
                };
            });
        }
    }

    // --- Initial Setup and Authentication ---

    // Apply saved theme on initial load before first render
    updateTheme(currentState.theme);

    onAuthStateChanged(auth, async (user) => {
        if (!currentState.isAuthReady) {
            // First run, check for custom token
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else if (!user) {
                    // Sign in anonymously if no custom token and no current user
                    await signInAnonymously(auth);
                }
            } catch (error) {
                if (error.code === 'auth/custom-token-mismatch') {
                    console.warn("Initial Auth Warning: Custom token mismatch. Proceeding with Anonymous Sign-in.", error.message);
                } else {
                    console.error("Initial Auth Error:", error);
                }
                
                // Fallback to anonymous sign-in if custom token fails
                try {
                    await signInAnonymously(auth);
                } catch (anonError) {
                    console.error("Anonymous Sign-in Failed:", anonError);
                }
            }

            // Re-check user state after initial sign-in attempt
            const finalUser = auth.currentUser;
            const finalUserId = finalUser?.uid || 'anon-' + crypto.randomUUID();

            updateState({ 
                user: finalUser, 
                userId: finalUserId, 
                isAuthReady: true,
                view: finalUser && !finalUser.isAnonymous ? 'home' : 'login' // Start at home if signed in and not anonymous, otherwise login
            });

            // Start data listener only after auth is ready
            startAppListener();

        } else {
            // Subsequent changes (e.g., sign out, sign in)
            const finalUserId = user?.uid || 'anon-' + crypto.randomUUID();
            updateState({ 
                user: user, 
                userId: finalUserId,
                view: user && !user.isAnonymous ? currentState.view : 'login' // If user signs out or is anonymous, go to login
            });
        }
    });

    // Initial render while waiting for auth state
    renderApp(); 
</script>

</body>
</html>
