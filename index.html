<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareApp - Firebase SPA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(90deg, #A78BFA 0%, #8B5CF6 100%);
        }
        .nav-button.active {
            color: #8B5CF6;
        }
        #app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .app-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        @media (max-width: 640px) {
            .app-grid {
                grid-template-columns: 1fr;
            }
        }
        .screenshot-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .screenshot-modal.active {
            display: flex;
        }
        .screenshot-content {
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }
    </style>
</head>
<body class="transition-colors duration-300">

    <div id="app" class="relative">
        </div>

        <!-- Screenshot Modal -->
        <div id="screenshot-modal" class="screenshot-modal">
            <div class="screenshot-content relative">
                <button id="close-modal" class="absolute top-2 right-2 z-10 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center">×</button>
                <div id="modal-body" class="p-6 max-h-[80vh] overflow-y-auto">
                    <!-- Modal content will be loaded here -->
                </div>
            </div>
        </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword, 
        signOut,
        signInAnonymously,
        signInWithCustomToken,
        updateProfile
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        query, 
        onSnapshot, 
        updateDoc, 
        doc, 
        deleteDoc, 
        serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAUL74mqVCIY1MMclrRhdVbY_VyP4lgQpY",
        authDomain: "waiappstore.firebaseapp.com",
        projectId: "waiappstore",
        storageBucket: "waiappstore.firebasestorage.app",
        messagingSenderId: "161610339691",
        appId: "1:161610339691:web:ce59fafb6a21729030682e",
        measurementId: "G-HH95X102MG"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const sharedAppsCollectionPath = "sharedApps";
    const adminEmail = "c388925@gmail.com"; 
    const initialAuthToken = null; 

    const translations = {
        en: {
            APP_TITLE: "ShareApp Store", HOME: "Home", UPLOAD: "Upload", PROFILE: "Profile", SETTINGS: "Settings", ADMIN: "Admin", SIGN_IN: "Sign In", SIGN_UP: "Sign Up", SIGN_OUT: "Sign Out", PASSWORD: "Password", EMAIL: "Email", NO_ACCOUNT: "Need an account? Sign Up", ACCOUNT_LOGIN: "Already have an account? Sign In", OR: "OR", SIGN_IN_WITH_GOOGLE: "Sign in with Google", SECRET_CODE: "Your secret code", DEVELOPER_NOTE: "Note: Please use the Email/Password fields to sign in.", USER_ID: "User ID", NOT_LOGGED_IN: "Not Logged In", PENDING: "Pending Review", APPROVED: "Approved", DOWNLOAD_OR_OPEN: "Get App", NO_APPS_YET: "No approved apps yet. Be the first to submit!", CATEGORIES: "Categories", ALL: "All", GAMES: "Games", SOCIAL: "Social", PRODUCTIVITY: "Productivity", ENTERTAINMENT: "Entertainment", SEARCH_PLACEHOLDER: "Search for apps...", LATEST_APPS: "Latest Shared Apps", SUBMITTED_BY: "Submitted by", SUBMITTED_DATE: "Date", UNKNOWN: "Unknown", APP_INFO: "App Submission", APP_NAME: "App Name", APP_ICON_LINK: "Icon URL", APP_LINK: "App Link (Play Store, etc.)", CATEGORY: "Category", SELECT_CATEGORY: "Select Category", SUBMIT_APP: "Submit App", LOGIN_REQUIRED: "You must sign in to submit an app.", UPLOAD_SUCCESS: "Upload Successful!", UPLOAD_FAILED: "Upload Failed", DATA_FETCH_FAILED: "Failed to fetch data.", SETTING_THEME: "Theme Settings", LIGHT_MODE: "Light Mode", DARK_MODE: "Dark Mode", THEME_APPLIED: "Theme applied.", SETTING_LANGUAGE: "Language", LANGUAGE_APPLIED: "Language applied.", NO_NAME: "No Name", NO_EMAIL: "No Email", EMAIL_PASSWORD: "Email/Password", YOUR_SUBMISSIONS: "Your Submissions", NO_SUBMISSIONS_YET: "You have not submitted any apps yet.", ACCESS_DENIED: "Access Denied", ACCESS_DENIED_MESSAGE: "You do not have administrative privileges.", ADMIN_AREA: "Moderation Queue", SUBMISSIONS: "Submissions", UNAPPROVE: "Unapprove", APPROVE: "Approve", EDIT_APP: "Edit App Details", SAVE_CHANGES: "Save Changes", CANCEL: "Cancel",
            PURPOSE: "App Purpose", SCREENSHOTS: "Screenshots", SCREENSHOT1: "Screenshot 1", SCREENSHOT2: "Screenshot 2", SCREENSHOT3: "Screenshot 3", USERNAME: "Username", CONTACT_INFO: "Contact Information", AGE: "Age", LANGUAGE: "Language", VIEW_SCREENSHOTS: "View Screenshots", SCREENSHOT_GALLERY: "Screenshot Gallery", APP_DETAILS: "App Details", CLOSE: "Close", UPDATE_USERNAME: "Update Username", CURRENT_USERNAME: "Current Username", NEW_USERNAME: "New Username", UPDATE: "Update", USERNAME_UPDATED: "Username updated successfully"
        },
        my: {
            APP_TITLE: "ShareApp စတိုး", HOME: "ပင်မ", UPLOAD: "တင်သွင်းရန်", PROFILE: "ပရိုဖိုင်", SETTINGS: "ချိန်ညှိချက်များ", ADMIN: "စီမံခန့်ခွဲသူ", SIGN_IN: "ဝင်ရောက်ရန်", SIGN_UP: "အကောင့်ဖွင့်ရန်", SIGN_OUT: "အကောင့်ထွက်ရန်", PASSWORD: "လျှို့ဝှက်နံပါတ်", EMAIL: "အီးမေးလ်", NO_ACCOUNT: "အကောင့်မရှိဘူးလား။ အကောင့်ဖွင့်ပါ", ACCOUNT_LOGIN: "အကောင့်ရှိပြီးသားလား။ ဝင်ရောက်ပါ", OR: "သို့မဟုတ်", SIGN_IN_WITH_GOOGLE: "Google ဖြင့် ဝင်ရောက်ရန်", SECRET_CODE: "လျှို့ဝှက်နံပါတ်", DEVELOPER_NOTE: "သတိပေးချက်- အီးမေးလ်/စကားဝှက်ဖြည့်ပြီး ဝင်ရောက်ပါ။", USER_ID: "အသုံးပြုသူ ID", NOT_LOGGED_IN: "မဝင်ရောက်ရသေးပါ", PENDING: "စောင့်ဆိုင်းဆဲ", APPROVED: "ခွင့်ပြုပြီး", DOWNLOAD_OR_OPEN: "App ရယူရန်", NO_APPS_YET: "ခွင့်ပြုထားသော App မရှိသေးပါ။ ပထမဆုံးတင်သွင်းသူ ဖြစ်ပါစေ။", CATEGORIES: "အမျိုးအစားများ", ALL: "အားလုံး", GAMES: "ဂိမ်း", SOCIAL: "လူမှုကွန်ရက်", PRODUCTIVITY: "အလုပ်စွမ်းဆောင်ရည်", ENTERTAINMENT: "ဖျော်ဖြေရေး", SEARCH_PLACEHOLDER: "Apps များ ရှာဖွေပါ...", LATEST_APPS: "နောက်ဆုံးတင်သွင်းသော Apps များ", SUBMITTED_BY: "တင်သွင်းသူ", SUBMITTED_DATE: "တင်သွင်းသည့်နေ့", UNKNOWN: "မသိရှိရ", APP_INFO: "App အချက်အလက်", APP_NAME: "App အမည်", APP_ICON_LINK: "Icon လင့်ခ်", APP_LINK: "App လင့်ခ် (Play Store, etc.)", CATEGORY: "အမျိုးအစား", SELECT_CATEGORY: "အမျိုးအစား ရွေးပါ", SUBMIT_APP: "App တင်သွင်းရန်", LOGIN_REQUIRED: "App တင်သွင်းရန်အတွက် ဝင်ရောက်ရန်လိုအပ်သည်။", UPLOAD_SUCCESS: "တင်သွင်းမှု အောင်မြင်ပါသည်!", UPLOAD_FAILED: "တင်သွင်းမှု မအောင်မြင်ပါ", DATA_FETCH_FAILED: "ဒေတာရယူရာတွင် အမှားဖြစ်ခဲ့သည်။", SETTING_THEME: "Theme ချိန်ညှိချက်များ", LIGHT_MODE: "အလင်းရောင် Theme", DARK_MODE: "အမှောင် Theme", THEME_APPLIED: "Theme ပြောင်းလဲပြီးပါပြီ။", SETTING_LANGUAGE: "ဘာသာစကား", LANGUAGE_APPLIED: "ဘာသာစကား ပြောင်းလဲပြီးပါပြီ။", NO_NAME: "အမည်မရှိ", NO_EMAIL: "အီးမေးလ်မရှိ", EMAIL_PASSWORD: "အီးမေးလ်/စကားဝှက်", YOUR_SUBMISSIONS: "သင်တင်သွင်းခဲ့သော Apps များ", NO_SUBMISSIONS_YET: "သင် App တစ်ခုမှ တင်သွင်းရသေးခြင်း မရှိပါ။", ACCESS_DENIED: "ဝင်ရောက်ခွင့် မပြုပါ", ACCESS_DENIED_MESSAGE: "သင့်တွင် စီမံခန့်ခွဲသူ အခွင့်အရေး မရှိပါ။", ADMIN_AREA: "စီမံခန့်ခွဲမှု", SUBMISSIONS: "တင်သွင်းမှုများ", UNAPPROVE: "ခွင့်ပြုချက် ရုပ်သိမ်း", APPROVE: "ခွင့်ပြုရန်", EDIT_APP: "App အချက်အလက် ပြင်ဆင်ရန်", SAVE_CHANGES: "အပြောင်းအလဲများ သိမ်းဆည်း", CANCEL: "ပယ်ဖျက်မည်",
            PURPOSE: "App ၏ ရည်ရွယ်ချက်", SCREENSHOTS: "ပုံရိပ်များ", SCREENSHOT1: "ပုံရိပ် ၁", SCREENSHOT2: "ပုံရိပ် ၂", SCREENSHOT3: "ပုံရိပ် ၃", USERNAME: "အသုံးပြုသူအမည်", CONTACT_INFO: "ဆက်သွယ်ရန်", AGE: "အသက်", LANGUAGE: "ဘာသာစကား", VIEW_SCREENSHOTS: "ပုံရိပ်များ ကြည့်ရန်", SCREENSHOT_GALLERY: "ပုံရိပ်များ", APP_DETAILS: "App အချက်အလက်", CLOSE: "ပိတ်မည်", UPDATE_USERNAME: "အသုံးပြုသူအမည် ပြောင်းလဲရန်", CURRENT_USERNAME: "လက်ရှိအသုံးပြုသူအမည်", NEW_USERNAME: "အသစ်ပြောင်းလဲမည့်အမည်", UPDATE: "ပြောင်းလဲမည်", USERNAME_UPDATED: "အသုံးပြုသူအမည် ပြောင်းလဲပြီးပါပြီ"
        },
    };

    let currentState = {
        view: 'home', 
        authMode: 'login', 
        user: null, 
        userId: null,
        isAuthReady: false,
        sharedApps: [], 
        theme: localStorage.getItem('theme') || 'light', 
        language: localStorage.getItem('language') || 'my', 
        message: null,
        error: null,
        editingAppId: null,
        selectedCategory: 'all',
        searchQuery: '',
        showWelcomeMessage: false // New state to control welcome message
    };

    function T(key) {
        return translations[currentState.language]?.[key] || translations['en'][key] || key;
    }

    function updateTheme(theme) {
        document.body.classList.remove('bg-white', 'bg-gray-900');
        if (theme === 'dark') {
            document.body.classList.add('bg-gray-900');
            document.documentElement.classList.add('dark');
        } else {
            document.body.classList.add('bg-white');
            document.documentElement.classList.remove('dark');
        }
        localStorage.setItem('theme', theme);
    }

    function updateState(newState) {
        Object.assign(currentState, newState);
        renderApp();
        updateTheme(currentState.theme);
    }

    function showMessage(msg, isError = false) {
        updateState({ message: isError ? null : msg, error: isError ? msg : null });
        setTimeout(() => updateState({ message: null, error: null }), 3000);
    }

    function icon(name, classes = 'w-6 h-6 mr-2') {
        return `<i data-lucide="${name}" class="${classes}"></i>`;
    }

    function isAdmin() {
        return currentState.user && currentState.user.email === adminEmail;
    }

    // Screenshot Modal Functions
    function showScreenshotModal(app) {
        const modal = document.getElementById('screenshot-modal');
        const modalBody = document.getElementById('modal-body');
        
        const screenshotsHtml = app.screenshots && app.screenshots.length > 0 
            ? app.screenshots.map((screenshot, index) => `
                <div class="mb-4">
                    <img src="${screenshot}" 
                         alt="${T('SCREENSHOT')} ${index + 1}" 
                         class="w-full h-auto rounded-lg shadow-md"
                         onerror="this.src='https://placehold.co/600x400/A78BFA/ffffff?text=Screenshot+${index + 1}'">
                </div>
            `).join('')
            : `<p class="text-center text-gray-500 py-4">No screenshots available</p>`;

        modalBody.innerHTML = `
            <div class="${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'}">
                <div class="flex items-center mb-4">
                    <img src="${app.iconLink || 'https://placehold.co/60x60/A78BFA/ffffff?text=App'}" 
                         alt="App Icon" 
                         class="w-12 h-12 rounded-lg mr-3"
                         onerror="this.src='https://placehold.co/60x60/A78BFA/ffffff?text=App'">
                    <div>
                        <h2 class="text-xl font-bold">${app.name}</h2>
                        <p class="text-sm text-violet-500">${app.category}</p>
                    </div>
                </div>
                
                ${app.purpose ? `
                    <div class="mb-6">
                        <h3 class="font-semibold mb-2">${T('PURPOSE')}</h3>
                        <p class="text-sm ${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-600'}">${app.purpose}</p>
                    </div>
                ` : ''}
                
                <div class="mb-6">
                    <h3 class="font-semibold mb-3">${T('SCREENSHOT_GALLERY')}</h3>
                    <div class="space-y-4">
                        ${screenshotsHtml}
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <a href="${app.link}" target="_blank" 
                       class="flex-1 py-3 text-center rounded-lg text-white font-semibold shadow-md transition duration-150 ease-in-out gradient-bg hover:shadow-lg">
                        ${T('DOWNLOAD_OR_OPEN')}
                    </a>
                </div>
            </div>
        `;
        
        modal.classList.add('active');
    }

    function closeScreenshotModal() {
        const modal = document.getElementById('screenshot-modal');
        modal.classList.remove('active');
    }

    async function handleSignIn(email, password) {
        try {
            await signInWithEmailAndPassword(auth, email, password);
            // Don't show welcome message on successful login
            updateState({ view: 'home' }); 
        } catch (error) {
            console.error("Sign In Error:", error);
            showMessage(`${T('SIGN_IN')} ${T('UPLOAD_FAILED')}: ${error.message}`, true);
        }
    }

    async function handleSignUp(email, password) {
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            // Don't show welcome message on successful signup
            updateState({ view: 'home' });
        } catch (error) {
            console.error("Sign Up Error:", error);
            showMessage(`${T('SIGN_UP')} ${T('UPLOAD_FAILED')}: ${error.message}`, true);
        }
    }

    async function handleSignOut() {
        try {
            await signOut(auth);
            showMessage(T('SIGN_OUT') + " " + T('UPLOAD_SUCCESS'));
            updateState({ user: null, view: 'login' });
        } catch (error) {
            console.error("Sign Out Error:", error);
            showMessage(`${T('SIGN_OUT')} ${T('UPLOAD_FAILED')}: ${error.message}`, true);
        }
    }

    async function updateUsername(newUsername) {
        try {
            await updateProfile(auth.currentUser, {
                displayName: newUsername
            });
            showMessage(T('USERNAME_UPDATED'));
            updateState({ user: auth.currentUser });
        } catch (error) {
            console.error("Username Update Error:", error);
            showMessage("Username update failed: " + error.message, true);
        }
    }

    async function handleAppApproval(appId, isApproved) {
        if (!isAdmin()) return showMessage(T('ACCESS_DENIED'), true);
        try {
            const appRef = doc(db, sharedAppsCollectionPath, appId);
            await updateDoc(appRef, { isApproved: isApproved });
            showMessage(isApproved ? T('APPROVED') : T('PENDING'));
        } catch (error) {
            console.error("Approval Error:", error);
            showMessage(T('UPLOAD_FAILED') + `: ${error.message}`, true);
        }
    }

    async function handleAppDeletion(appId) {
        if (!isAdmin()) return showMessage(T('ACCESS_DENIED'), true);
        if (!confirm('Are you sure you want to delete this app?')) return; 
        try {
            await deleteDoc(doc(db, sharedAppsCollectionPath, appId));
            showMessage(T('UPLOAD_SUCCESS') + " (Deleted)"); 
        } catch (error) {
            console.error("Deletion Error:", error);
            showMessage(T('UPLOAD_FAILED') + `: ${error.message}`, true);
        }
    }

    async function handleAppEdit(appId, name, link, iconLink, purpose, screenshots) {
        if (!isAdmin()) return showMessage(T('ACCESS_DENIED'), true);
        try {
            const appRef = doc(db, sharedAppsCollectionPath, appId);
            await updateDoc(appRef, { 
                name, 
                link, 
                iconLink, 
                purpose, 
                screenshots
            });
            showMessage(T('SAVE_CHANGES') + " " + T('UPLOAD_SUCCESS'));
            updateState({ editingAppId: null });
        } catch (error) {
            console.error("Edit Error:", error);
            showMessage(T('UPLOAD_FAILED') + `: ${error.message}`, true);
        }
    }

    async function handleAppUpload(name, link, iconLink, category, purpose, screenshots) {
        if (!currentState.user || currentState.userId.includes('anon')) {
            return showMessage(T('LOGIN_REQUIRED'), true);
        }
        try {
            await addDoc(collection(db, sharedAppsCollectionPath), {
                name: name,
                link: link,
                iconLink: iconLink,
                category: category,
                purpose: purpose,
                screenshots: screenshots || [],
                userId: currentState.userId,
                userName: currentState.user?.displayName || currentState.user?.email || 'N/A',
                isApproved: false, 
                createdAt: serverTimestamp()
            });
            showMessage(`${T('UPLOAD_SUCCESS')} (${T('PENDING')})`);
            updateState({ view: 'profile' }); 
        } catch (error) {
            console.error("Upload Error:", error);
            showMessage(`${T('UPLOAD_FAILED')}: ${error.message.substring(0, 50)}...`, true);
        }
    }

    function startAppListener() {
        if (!currentState.isAuthReady) return;

        const q = query(collection(db, sharedAppsCollectionPath));

        onSnapshot(q, (snapshot) => {
            const apps = [];
            snapshot.forEach((doc) => {
                apps.push({ id: doc.id, ...doc.data() });
            });
            apps.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            updateState({ sharedApps: apps });
        }, (error) => {
            console.error("Firestore Listener Error:", error);
            showMessage(T('DATA_FETCH_FAILED'), true);
        });
    }

    function renderHeader(titleKey) {
        return `
            <header class="p-4 flex justify-between items-center border-b border-gray-100 sticky top-0 z-10 ${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white'}">
                <button id="menu-toggle-btn" class="p-2 rounded-full ${currentState.theme === 'dark' ? 'hover:bg-gray-700 text-gray-300' : 'hover:bg-gray-100 text-gray-700'}">
                    ${icon('menu')}
                </button>
                
                <h1 class="text-xl font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'}">${T(titleKey)}</h1>
                
                <button id="auth-action-btn" class="p-2 rounded-full gradient-bg shadow-md" data-action="${currentState.user ? 'signout' : 'login'}">
                    ${icon(currentState.user ? 'log-out' : 'user', 'w-4 h-4 text-white')}
                </button>
            </header>
        `;
    }

    function renderSideMenu() {
        const userIdDisplay = currentState.userId ? `${T('USER_ID')}: ${currentState.userId}` : T('NOT_LOGGED_IN');
        return `
            <div id="side-menu" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden" data-menu-close>
                <div class="${currentState.theme === 'dark' ? 'bg-gray-700' : 'bg-white'} h-full w-3/4 max-w-xs p-6 shadow-2xl" onclick="event.stopPropagation()">
                    <h2 class="text-2xl font-bold text-violet-600 mb-4">ShareApp</h2>
                    <p class="text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mb-6 break-all">${userIdDisplay}</p>
                    
                    <ul class="space-y-2">
                        <li><a href="#" data-view-target="home" class="flex items-center p-3 text-gray-700 ${currentState.theme === 'dark' ? 'text-gray-200 hover:bg-gray-600' : 'hover:bg-violet-50'} rounded-lg">${icon('home')} <span class="ml-3">${T('HOME')}</span></a></li>
                        <li><a href="#" data-view-target="upload" class="flex items-center p-3 text-gray-700 ${currentState.theme === 'dark' ? 'text-gray-200 hover:bg-gray-600' : 'hover:bg-violet-50'} rounded-lg">${icon('upload')} <span class="ml-3">${T('UPLOAD')}</span></a></li>
                        <li><a href="#" data-view-target="settings" class="flex items-center p-3 text-gray-700 ${currentState.theme === 'dark' ? 'text-gray-200 hover:bg-gray-600' : 'hover:bg-violet-50'} rounded-lg">${icon('settings')} <span class="ml-3">${T('SETTINGS')}</span></a></li>
                        ${currentState.user ? `
                            <li><a href="#" data-view-target="profile" class="flex items-center p-3 text-gray-700 ${currentState.theme === 'dark' ? 'text-gray-200 hover:bg-gray-600' : 'hover:bg-violet-50'} rounded-lg">${icon('user')} <span class="ml-3">${T('PROFILE')}</span></a></li>
                            ${isAdmin() ? `<li><a href="#" data-view-target="admin" class="flex items-center p-3 text-gray-700 ${currentState.theme === 'dark' ? 'text-gray-200 hover:bg-gray-600' : 'hover:bg-violet-50'} rounded-lg">${icon('lock')} <span class="ml-3">${T('ADMIN')}</span></a></li>` : ''}
                            <li><a href="#" id="menu-sign-out-btn" class="flex items-center p-3 text-gray-700 ${currentState.theme === 'dark' ? 'text-gray-200 hover:bg-gray-600' : 'hover:bg-violet-50'} rounded-lg">${icon('log-out')} <span class="ml-3">${T('SIGN_OUT')}</span></a></li>
                        ` : `
                            <li><a href="#" data-view-target="login" class="flex items-center p-3 text-gray-700 ${currentState.theme === 'dark' ? 'text-gray-200 hover:bg-gray-600' : 'hover:bg-violet-50'} rounded-lg">${icon('log-in')} <span class="ml-3">${T('SIGN_IN')}</span></a></li>
                        `}
                    </ul>
                    
                    <div class="mt-8 pt-4 border-t ${currentState.theme === 'dark' ? 'border-gray-600' : 'border-gray-200'}">
                        <h3 class="text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mb-2">${T('CONTACT_INFO')}</h3>
                        <div class="space-y-2 text-xs ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}">
                            <div>Email: <a href="mailto:c388925@gmail.com" class="text-violet-500 hover:text-violet-400">c388925@gmail.com</a></div>
                            <div>Telegram: <a href="https://t.me/appcreator24myanmar" target="_blank" class="text-violet-500 hover:text-violet-400">@appcreator24myanmar</a></div>
                            <div>Facebook: <a href="https://m.facebook.com/yan260702/" target="_blank" class="text-violet-500 hover:text-violet-400">Yan</a></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderHome() {
        let approvedApps = currentState.sharedApps.filter(app => app.isApproved);
        
        if (currentState.selectedCategory !== 'all') {
            approvedApps = approvedApps.filter(app => app.category === currentState.selectedCategory);
        }
        
        if (currentState.searchQuery) {
            approvedApps = approvedApps.filter(app => 
                app.name.toLowerCase().includes(currentState.searchQuery.toLowerCase()) ||
                app.category.toLowerCase().includes(currentState.searchQuery.toLowerCase()) ||
                (app.purpose && app.purpose.toLowerCase().includes(currentState.searchQuery.toLowerCase()))
            );
        }

        const categories = ['all', 'Game', 'Social', 'Productivity', 'Entertainment', 'Education'];
        const categoryButtons = categories.map(cat => {
            const isActive = currentState.selectedCategory === cat;
            return `
                <button data-category="${cat}" 
                    class="category-btn ${isActive ? 'bg-violet-500 text-white' : 'bg-gray-100 text-gray-700'} 
                    ${currentState.theme === 'dark' && !isActive ? 'bg-gray-700 text-gray-300' : ''} 
                    text-xs font-medium px-3 py-1 rounded-full flex-shrink-0 transition-colors">
                    ${cat === 'all' ? T('ALL') : 
                      cat === 'Game' ? T('GAMES') : 
                      cat === 'Social' ? T('SOCIAL') : 
                      cat === 'Productivity' ? T('PRODUCTIVITY') : 
                      cat === 'Entertainment' ? T('ENTERTAINMENT') : 'ပညာရေး'}
                </button>
            `;
        }).join('');

        const appListHtml = approvedApps.length > 0
            ? `<div class="app-grid">
                ${approvedApps.map(app => `
                    <div class="app-link-card ${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-4 shadow-sm rounded-xl border flex flex-col">
                        <div class="flex items-center mb-2">
                            <div class="p-1 rounded-lg mr-3 flex-shrink-0 w-10 h-10 flex items-center justify-center">
                                <img src="${app.iconLink || 'https://placehold.co/40x40/A78BFA/ffffff?text=App'}" 
                                    onerror="this.onerror=null; this.src='https://placehold.co/40x40/A78BFA/ffffff?text=App';"
                                    alt="App Icon" class="w-full h-full object-contain rounded-md">
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-lg font-semibold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} truncate">${app.name}</p>
                                <p class="text-xs text-violet-500 font-medium">${app.category}</p>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2 mb-3">
                            <button data-view-app="${app.id}" class="flex-1 py-2 px-3 rounded-lg bg-blue-500 text-white text-sm font-medium hover:bg-blue-600 transition duration-150">
                                ${T('VIEW_SCREENSHOTS')}
                            </button>
                            <a href="${app.link}" target="_blank" class="flex-1 py-2 px-3 rounded-lg text-white text-sm font-medium text-center shadow-md transition duration-150 ease-in-out gradient-bg hover:shadow-lg">
                                ${T('DOWNLOAD_OR_OPEN')}
                            </a>
                        </div>
                        
                        <p class="text-xs ${currentState.theme === 'dark' ? 'text-gray-500' : 'text-gray-400'} text-right">${T('SUBMITTED_DATE')}: ${app.createdAt ? new Date(app.createdAt.toDate()).toLocaleDateString(currentState.language === 'th' ? 'th-TH' : 'en-US') : T('UNKNOWN')}</p>
                    </div>
                `).join('')}
            </div>`
            : `<p class="text-center ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} p-8">${T('NO_APPS_YET')}</p>`;

        return `
            ${renderHeader('APP_TITLE')}
            ${renderSideMenu()}
            <main class="flex-grow p-4 space-y-4 overflow-y-auto">
                
                <div class="relative">
                    <input type="text" id="search-input" placeholder="${T('SEARCH_PLACEHOLDER')}" 
                        value="${currentState.searchQuery}" 
                        class="w-full p-3 pl-10 border ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-200 bg-white'} rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition duration-150">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-400'}">${icon('search', 'w-4 h-4')}</span>
                </div>

                <h2 class="text-base font-semibold ${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}">${T('CATEGORIES')}</h2>
                <div class="flex space-x-2 overflow-x-auto pb-2">
                    ${categoryButtons}
                </div>
                
                <h2 class="text-base font-semibold ${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} pt-2">${T('LATEST_APPS')} (${approvedApps.length})</h2>
                <div class="space-y-4">
                    ${appListHtml}
                </div>
            </main>
        `;
    }

    function renderUpload() {
        return `
            ${renderHeader('UPLOAD')}
            ${renderSideMenu()}
            <main class="flex-grow p-6 overflow-y-auto">
                <form id="upload-form" class="space-y-6 ${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-6 rounded-xl shadow-lg border">
                    <h2 class="text-xl font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-700'}">${T('APP_INFO')}</h2>
                    
                    <div>
                        <label for="appName" class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('APP_NAME')}</label>
                        <input type="text" id="appName" name="appName" required placeholder="ဥပမာ: Amazing Photo Editor" class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}">
                    </div>
                    
                    <div>
                        <label for="appIconLink" class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('APP_ICON_LINK')}</label>
                        <input type="url" id="appIconLink" name="appIconLink" placeholder="ဥပမာ: https://example.com/icon.png (Optional)" class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}">
                    </div>

                    <div>
                        <label for="appLink" class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('APP_LINK')}</label>
                        <input type="url" id="appLink" name="appLink" required placeholder="https://play.google.com/store/..." class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}">
                    </div>

                    <div>
                        <label for="purpose" class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('PURPOSE')}</label>
                        <textarea id="purpose" name="purpose" placeholder="App ၏ ရည်ရွယ်ချက်ကို ရေးပါ..." class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'} h-20"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('SCREENSHOTS')} (3)</label>
                        <div class="space-y-2">
                            <input type="url" id="screenshot1" name="screenshot1" placeholder="${T('SCREENSHOT1')} URL" class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}">
                            <input type="url" id="screenshot2" name="screenshot2" placeholder="${T('SCREENSHOT2')} URL" class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}">
                            <input type="url" id="screenshot3" name="screenshot3" placeholder="${T('SCREENSHOT3')} URL" class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}">
                        </div>
                    </div>

                    <div>
                        <label for="category" class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('CATEGORY')}</label>
                        <select id="category" name="category" required class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300 bg-white'}">
                            <option value="">${T('SELECT_CATEGORY')}</option>
                            <option value="Game">${T('GAMES')}</option>
                            <option value="Social">${T('SOCIAL')}</option>
                            <option value="Productivity">${T('PRODUCTIVITY')}</option>
                            <option value="Entertainment">${T('ENTERTAINMENT')}</option>
                            <option value="Education">ပညာရေး</option>
                        </select>
                    </div>

                    <button type="submit" class="w-full py-3 px-4 rounded-lg text-white font-semibold shadow-lg transition duration-150 ease-in-out gradient-bg hover:opacity-90">
                        <span class="flex items-center justify-center">${icon('upload', 'w-5 h-5 mr-2')} ${T('SUBMIT_APP')}</span>
                    </button>
                    ${!currentState.user || currentState.userId.includes('anon') ? `<p class="text-sm text-red-500 text-center mt-4">${T('LOGIN_REQUIRED')}</p>` : ''}
                </form>
            </main>
        `;
    }

    function renderProfile() {
        const user = currentState.user;
        const displayName = user?.displayName || T('NO_NAME'); 
        const email = user?.email || T('NO_EMAIL');
        const photoURL = user?.photoURL || 'https://placehold.co/100x100/A78BFA/ffffff?text=U';
        const provider = user?.providerData?.[0]?.providerId || T('EMAIL_PASSWORD');

        const userApps = currentState.sharedApps.filter(app => app.userId === currentState.userId);

        const userAppsHtml = userApps.length > 0
            ? `<div class="app-grid">
                ${userApps.map(app => {
                const statusClass = app.isApproved ? 'bg-green-500' : 'bg-yellow-500';
                const statusText = app.isApproved ? T('APPROVED') : T('PENDING');
                return `
                    <div class="app-link-card ${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-3 shadow-sm rounded-xl border flex flex-col">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <div class="p-1 rounded-lg mr-3 flex-shrink-0 w-10 h-10 flex items-center justify-center">
                                    <img src="${app.iconLink || 'https://placehold.co/40x40/A78BFA/ffffff?text=App'}" 
                                        onerror="this.onerror=null; this.src='https://placehold.co/40x40/A78BFA/ffffff?text=App';"
                                        alt="App Icon" class="w-full h-full object-contain rounded-md">
                                </div>
                                <div>
                                    <p class="text-sm font-semibold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} truncate">${app.name}</p>
                                    <p class="text-xs ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}">${T('CATEGORY')}: ${app.category}</p>
                                </div>
                            </div>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <button data-view-app="${app.id}" class="flex-1 py-1 px-2 rounded bg-blue-500 text-white text-xs font-medium hover:bg-blue-600">
                                ${T('VIEW_SCREENSHOTS')}
                            </button>
                            <a href="${app.link}" target="_blank" class="flex-1 py-1 px-2 rounded text-white text-xs font-medium text-center gradient-bg hover:opacity-90">
                                ${T('DOWNLOAD_OR_OPEN')}
                            </a>
                        </div>
                    </div>
                `;
            }).join('')}
            </div>`
            : `<p class="text-center ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} p-4">${T('NO_SUBMISSIONS_YET')}</p>`;

        return `
            ${renderHeader('PROFILE')}
            ${renderSideMenu()}
            <main class="flex-grow p-6 overflow-y-auto flex flex-col items-center">
                <div class="${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-6 rounded-xl shadow-lg border w-full max-w-sm text-center mb-6">
                    <img src="${photoURL}" onerror="this.onerror=null; this.src='https://placehold.co/100x100/A78BFA/ffffff?text=U';" alt="Profile Image" class="w-24 h-24 rounded-full mx-auto mb-4 object-cover border-4 border-violet-100">
                    
                    <h2 class="text-2xl font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} mb-1">${displayName}</h2>
                    <p class="text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mb-4">${email}</p>
                    <p class="text-xs ${currentState.theme === 'dark' ? 'text-gray-500' : 'text-gray-500'} mb-6">ဝင်ရောက်မှုနည်းလမ်း: ${provider}</p>

                    <!-- Username Update Section -->
                    <div class="mb-4 p-4 ${currentState.theme === 'dark' ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg">
                        <h3 class="text-lg font-semibold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} mb-2">${T('UPDATE_USERNAME')}</h3>
                        <div class="flex space-x-2">
                            <input type="text" id="new-username" placeholder="${T('NEW_USERNAME')}" 
                                class="flex-1 p-2 border rounded-lg ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-600 text-white' : 'border-gray-300'}">
                            <button id="update-username-btn" class="py-2 px-4 rounded-lg bg-violet-500 text-white font-medium hover:bg-violet-600">
                                ${T('UPDATE')}
                            </button>
                        </div>
                        <p class="text-xs ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mt-2">${T('CURRENT_USERNAME')}: ${displayName}</p>
                    </div>

                    <button id="profile-sign-out-btn" class="w-full py-2 px-4 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition duration-150 ease-in-out shadow-md">
                        ${icon('log-out', 'w-5 h-5 mr-2 inline-block align-middle')} ${T('SIGN_OUT')}
                    </button>
                    <p class="text-xs ${currentState.theme === 'dark' ? 'text-gray-500' : 'text-gray-400'} mt-4 break-all">${T('USER_ID')}: ${currentState.userId}</p>
                </div>

                <div class="w-full">
                    <h3 class="text-xl font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} mb-3">${T('YOUR_SUBMISSIONS')}</h3>
                    <div class="w-full space-y-3">
                        ${userAppsHtml}
                    </div>
                </div>
            </main>
        `;
    }

    function renderSettings() {
        const langOptions = [
            { code: 'my', name: 'မြန်မာ (Myanmar)' },
            { code: 'en', name: 'English' }
        ];

        return `
            ${renderHeader('SETTINGS')}
            ${renderSideMenu()}
            <main class="flex-grow p-6 overflow-y-auto">
                <div class="${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-6 rounded-xl shadow-lg border space-y-8">
                    <h2 class="text-2xl font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} border-b ${currentState.theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} pb-3">${T('SETTINGS')}</h2>

                    <div>
                        <h3 class="text-xl font-semibold ${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} mb-3">${T('SETTING_THEME')}</h3>
                        <div class="flex space-x-4">
                            <button id="light-mode-btn" class="flex-1 py-3 rounded-lg border-2 ${currentState.theme === 'light' ? 'border-violet-500 bg-violet-50 text-violet-700' : 'border-gray-300'} ${currentState.theme === 'dark' ? 'bg-gray-700 text-gray-300' : 'bg-white'}" data-theme="light">
                                ${icon('sun', 'w-5 h-5 mr-2 inline-block align-middle')} ${T('LIGHT_MODE')}
                            </button>
                            <button id="dark-mode-btn" class="flex-1 py-3 rounded-lg border-2 ${currentState.theme === 'dark' ? 'border-violet-500 bg-violet-700 text-white' : 'border-gray-300'} ${currentState.theme === 'dark' ? 'bg-gray-700 text-gray-300' : 'bg-white'}" data-theme="dark">
                                ${icon('moon', 'w-5 h-5 mr-2 inline-block align-middle')} ${T('DARK_MODE')}
                            </button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold ${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} mb-3">${T('SETTING_LANGUAGE')}</h3>
                        <div id="language-options" class="grid grid-cols-2 gap-3">
                            ${langOptions.map(lang => `
                                <button data-lang="${lang.code}" 
                                    class="py-3 rounded-lg border-2 text-sm transition duration-150 
                                    ${currentState.language === lang.code ? 'border-violet-500 bg-violet-100 text-violet-700' : 'border-gray-300'}
                                    ${currentState.theme === 'dark' ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-white hover:bg-gray-50'}">
                                    ${lang.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold ${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} mb-3">${T('CONTACT_INFO')}</h3>
                        <div class="space-y-3 ${currentState.theme === 'dark' ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-lg">
                            <div class="flex items-center">
                                ${icon('mail', 'w-4 h-4 mr-2 text-violet-500')}
                                <span class="flex-1 ${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-600'}">Email:</span>
                                <a href="mailto:c388925@gmail.com" class="text-violet-500 hover:text-violet-400">c388925@gmail.com</a>
                            </div>
                            <div class="flex items-center">
                                ${icon('send', 'w-4 h-4 mr-2 text-violet-500')}
                                <span class="flex-1 ${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-600'}">Telegram:</span>
                                <a href="https://t.me/appcreator24myanmar" target="_blank" class="text-violet-500 hover:text-violet-400">@appcreator24myanmar</a>
                            </div>
                            <div class="flex items-center">
                                ${icon('thumbs-up', 'w-4 h-4 mr-2 text-violet-500')}
                                <span class="flex-1 ${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-600'}">Facebook:</span>
                                <a href="https://m.facebook.com/yan260702/" target="_blank" class="text-violet-500 hover:text-violet-400">Yan</a>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        `;
    }

    function renderAdmin() {
        const isUserAdmin = isAdmin();

        if (!isUserAdmin) {
             return `
                 ${renderHeader('ADMIN')}
                 ${renderSideMenu()}
                 <main class="flex-grow p-6 overflow-y-auto">
                     <div class="${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-8 rounded-xl shadow-lg border text-center space-y-4">
                         <p class="text-2xl text-red-500 font-bold">${icon('lock', 'w-8 h-8 mx-auto mb-2')} ${T('ACCESS_DENIED')}</p>
                         <p class="${currentState.theme === 'dark' ? 'text-gray-300' : 'text-gray-600'}">${T('ACCESS_DENIED_MESSAGE')}</p>
                     </div>
                 </main>
             `;
        }
        
        const allApps = currentState.sharedApps;

        const appListHtml = allApps.length > 0
            ? allApps.map(app => {
                const isEditing = currentState.editingAppId === app.id;
                const statusClass = app.isApproved ? 'bg-green-500' : 'bg-yellow-500';
                const statusText = app.isApproved ? T('APPROVED') : T('PENDING');

                if (isEditing) {
                    return `
                        <div class="app-link-card ${currentState.theme === 'dark' ? 'bg-gray-800' : 'bg-white'} p-4 rounded-xl border-2 border-violet-500 shadow-lg mb-4">
                            <h4 class="text-lg font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} mb-3">${T('EDIT_APP')}</h4>
                            <form data-app-id="${app.id}" class="admin-edit-form space-y-3">
                                <label class="block text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}">${T('APP_NAME')}</label>
                                <input type="text" name="name" value="${app.name}" class="w-full p-2 border rounded-md ${currentState.theme === 'dark' ? 'bg-gray-700 border-gray-600' : 'bg-gray-100 border-gray-300'}" required>
                                
                                <label class="block text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}">${T('APP_LINK')}</label>
                                <input type="url" name="link" value="${app.link}" class="w-full p-2 border rounded-md ${currentState.theme === 'dark' ? 'bg-gray-700 border-gray-600' : 'bg-gray-100 border-gray-300'}" required>
                                
                                <label class="block text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}">${T('APP_ICON_LINK')}</label>
                                <input type="url" name="iconLink" value="${app.iconLink || ''}" placeholder="${T('APP_ICON_LINK')}" class="w-full p-2 border rounded-md ${currentState.theme === 'dark' ? 'bg-gray-700 border-gray-600' : 'bg-gray-100 border-gray-300'}">
                                
                                <label class="block text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}">${T('PURPOSE')}</label>
                                <textarea name="purpose" class="w-full p-2 border rounded-md ${currentState.theme === 'dark' ? 'bg-gray-700 border-gray-600' : 'bg-gray-100 border-gray-300'} h-20">${app.purpose || ''}</textarea>
                                
                                <div class="flex space-x-2 pt-2">
                                    <button type="submit" class="flex-1 py-2 rounded-lg bg-green-500 text-white font-medium hover:bg-green-600">${T('SAVE_CHANGES')}</button>
                                    <button type="button" data-cancel-edit="${app.id}" class="py-2 px-4 rounded-lg bg-red-500 text-white font-medium hover:bg-red-600">${T('CANCEL')}</button>
                                </div>
                            </form>
                        </div>
                    `;
                }

                return `
                    <div class="app-link-card ${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-4 shadow-sm rounded-xl border mb-4">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center">
                                <div class="p-1 rounded-lg mr-3 flex-shrink-0 w-10 h-10 flex items-center justify-center">
                                    <img src="${app.iconLink || 'https://placehold.co/40x40/A78BFA/ffffff?text=App'}" 
                                        onerror="this.onerror=null; this.src='https://placehold.co/40x40/A78BFA/ffffff?text=App';"
                                        alt="App Icon" class="w-full h-full object-contain rounded-md">
                                </div>
                                <div>
                                    <p class="text-lg font-semibold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} truncate">${app.name}</p>
                                    <p class="text-xs ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}">(${app.category})</p>
                                </div>
                            </div>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                        ${app.purpose ? `<p class="text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mt-2">${app.purpose}</p>` : ''}
                        <p class="text-sm ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mt-2 mb-3">
                            ${T('SUBMITTED_BY')}: ${app.userName} | ${T('SUBMITTED_DATE')}: ${app.createdAt ? new Date(app.createdAt.toDate()).toLocaleDateString(currentState.language === 'th' ? 'th-TH' : 'en-US') : T('UNKNOWN')}
                        </p>
                        <div class="flex space-x-2">
                            <button data-approve="${app.id}" class="flex-1 py-2 rounded-lg ${app.isApproved ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white text-sm font-medium transition duration-150">
                                ${app.isApproved ? T('UNAPPROVE') : T('APPROVE')}
                            </button>
                            <button data-edit="${app.id}" class="py-2 px-3 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium transition duration-150">
                                ${icon('edit-2', 'w-4 h-4')}
                            </button>
                            <button data-delete="${app.id}" class="py-2 px-3 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium transition duration-150">
                                ${icon('trash', 'w-4 h-4')}
                            </button>
                        </div>
                    </div>
                `;
            }).join('')
            : `<p class="text-center ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} p-8">No apps submitted yet.</p>`;

        return `
            ${renderHeader('ADMIN')}
            ${renderSideMenu()}
            <main class="flex-grow p-6 overflow-y-auto">
                <div class="${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-4 rounded-xl shadow-lg border space-y-4">
                    <h3 class="text-xl font-bold ${currentState.theme === 'dark' ? 'text-white' : 'text-gray-800'} mb-3">${T('ADMIN_AREA')} (${allApps.length} ${T('SUBMISSIONS')})</h3>
                    <div class="space-y-4">
                        ${appListHtml}
                    </div>
                </div>
            </main>
        `;
    }

    function renderAuthView() {
        const isLogin = currentState.authMode === 'login';
        const title = isLogin ? T('SIGN_IN') : T('SIGN_UP');
        const actionButtonText = isLogin ? T('SIGN_IN') : T('SIGN_UP');

        return `
            ${renderHeader(isLogin ? 'SIGN_IN' : 'SIGN_UP')}
            ${renderSideMenu()}
            <main class="flex-grow p-6 overflow-y-auto flex flex-col justify-center">
                <div class="${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-8 rounded-xl shadow-2xl border w-full max-w-sm mx-auto space-y-6">
                    
                    <h2 class="text-3xl font-extrabold text-center text-violet-700">${title}</h2>

                    <p class="text-sm text-center ${currentState.theme === 'dark' ? 'text-yellow-400 bg-gray-700' : 'text-yellow-700 bg-yellow-100'} p-2 rounded-lg">${T('DEVELOPER_NOTE')}</p>

                    <form id="auth-form" class="space-y-4">
                        <div>
                            <label for="auth-email" class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('EMAIL')}</label>
                            <input type="email" id="auth-email" required class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}" placeholder="user@example.com">
                        </div>
                        <div>
                            <label for="auth-password" class="block text-sm font-medium ${currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-1">${T('PASSWORD')}</label>
                            <input type="password" id="auth-password" required class="w-full p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500 ${currentState.theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}" placeholder="${T('SECRET_CODE')}">
                        </div>

                        <button type="submit" class="w-full py-3 px-4 rounded-lg text-white font-semibold shadow-md gradient-bg hover:opacity-90 transition duration-150 ease-in-out">
                            ${actionButtonText}
                        </button>
                    </form>
                    
                    <button id="auth-mode-toggle-btn" class="w-full text-sm text-violet-600 font-medium hover:text-violet-500 mt-4">
                        ${isLogin ? T('NO_ACCOUNT') : T('ACCOUNT_LOGIN')}
                    </button>
                </div>
            </main>
        `;
    }

    function renderNavBar() {
        const navItems = [
            { id: 'home', labelKey: 'HOME', iconName: 'home' },
            { id: 'upload', labelKey: 'UPLOAD', iconName: 'upload' },
            { id: 'profile', labelKey: 'PROFILE', iconName: 'user' },
            { id: 'admin', labelKey: 'ADMIN', iconName: 'lock' },
            { id: 'settings', labelKey: 'SETTINGS', iconName: 'settings' },
        ];

        const navHtml = navItems.map(item => {
            if (item.id === 'admin' && !isAdmin()) return '';
            return `
                <button data-view-target="${item.id}" 
                        class="nav-button p-2 flex flex-col items-center justify-center text-xs transition duration-150 ${currentState.view === item.id ? 'active text-violet-600' : (currentState.theme === 'dark' ? 'text-gray-400' : 'text-gray-600')}">
                    ${icon(item.iconName, 'w-5 h-5 mb-1')}
                    <span class="mt-0">${T(item.labelKey)}</span>
                </button>
            `;
        }).join('');

        return `
            <nav class="sticky bottom-0 w-full ${currentState.theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border-t shadow-lg p-2 flex justify-around flex-shrink-0 z-10">
                ${navHtml}
            </nav>
        `;
    }

    function renderApp() {
        const appDiv = document.getElementById('app');
        if (!appDiv) return;

        let contentHtml;
        const currentView = currentState.user ? currentState.view : 'login'; 

        switch (currentView) {
            case 'home':
                contentHtml = renderHome();
                break;
            case 'upload':
                contentHtml = renderUpload();
                break;
            case 'profile':
                contentHtml = renderProfile();
                break;
            case 'admin':
                contentHtml = renderAdmin();
                break;
            case 'settings':
                contentHtml = renderSettings();
                break;
            case 'login':
            case 'signup':
            default:
                contentHtml = renderAuthView();
                break;
        }

        const messageBanner = (currentState.error || currentState.message) ? `
            <div class="p-3 text-sm text-center fixed top-0 left-0 right-0 z-50 transition-transform duration-300 ${currentState.error ? 'bg-red-500' : 'bg-green-500'} text-white shadow-lg">
                ${currentState.error || currentState.message}
            </div>
        ` : '';

        appDiv.innerHTML = messageBanner + contentHtml + (currentState.user ? renderNavBar() : '');

        lucide.createIcons();

        attachEventListeners(currentView);
    }

    function attachEventListeners(currentView) {
        // Modal event listeners
        const modal = document.getElementById('screenshot-modal');
        const closeModalBtn = document.getElementById('close-modal');
        
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', closeScreenshotModal);
        }
        
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeScreenshotModal();
                }
            });
        }

        const sideMenu = document.getElementById('side-menu');

        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        if (menuToggleBtn && sideMenu) {
            menuToggleBtn.addEventListener('click', () => sideMenu.classList.remove('hidden'));
        }

        if (sideMenu) {
            sideMenu.addEventListener('click', (e) => {
                if (e.target.hasAttribute('data-menu-close')) {
                    sideMenu.classList.add('hidden'); 
                }
            });
        }
        
        const authActionBtn = document.getElementById('auth-action-btn');
        if (authActionBtn) {
            authActionBtn.addEventListener('click', () => {
                const action = authActionBtn.getAttribute('data-action');
                if (action === 'signout') {
                    handleSignOut();
                } else if (action === 'login') {
                    updateState({ view: 'login' });
                }
            });
        }
        
        document.querySelectorAll('[data-view-target]').forEach(element => {
            element.addEventListener('click', (e) => {
                e.preventDefault();
                const targetView = element.getAttribute('data-view-target');
                updateState({ view: targetView });
                if (sideMenu) {
                    sideMenu.classList.add('hidden'); 
                }
            });
        });

        const menuSignOutBtn = document.getElementById('menu-sign-out-btn');
        if (menuSignOutBtn) {
            menuSignOutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                handleSignOut();
                if (sideMenu) {
                    sideMenu.classList.add('hidden');
                }
            });
        }
        
        if (currentView === 'home') {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    updateState({ searchQuery: e.target.value });
                });
            }

            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const category = e.currentTarget.getAttribute('data-category');
                    updateState({ selectedCategory: category });
                });
            });

            // Screenshot view buttons
            document.querySelectorAll('[data-view-app]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appId = e.currentTarget.getAttribute('data-view-app');
                    const app = currentState.sharedApps.find(a => a.id === appId);
                    if (app) {
                        showScreenshotModal(app);
                    }
                });
            });
        }
        
        if (currentView === 'upload') {
            const uploadForm = document.getElementById('upload-form');
            if (uploadForm) {
                uploadForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const appName = document.getElementById('appName').value;
                    const appLink = document.getElementById('appLink').value;
                    const appIconLink = document.getElementById('appIconLink').value;
                    const category = document.getElementById('category').value;
                    const purpose = document.getElementById('purpose').value;
                    const screenshot1 = document.getElementById('screenshot1').value;
                    const screenshot2 = document.getElementById('screenshot2').value;
                    const screenshot3 = document.getElementById('screenshot3').value;
                    
                    const screenshots = [];
                    if (screenshot1) screenshots.push(screenshot1);
                    if (screenshot2) screenshots.push(screenshot2);
                    if (screenshot3) screenshots.push(screenshot3);
                    
                    await handleAppUpload(appName, appLink, appIconLink, category, purpose, screenshots);
                };
            }
        } else if (currentView === 'profile') {
            const profileSignOutBtn = document.getElementById('profile-sign-out-btn');
            if (profileSignOutBtn) {
                profileSignOutBtn.addEventListener('click', handleSignOut);
            }

            // Username update
            const updateUsernameBtn = document.getElementById('update-username-btn');
            if (updateUsernameBtn) {
                updateUsernameBtn.addEventListener('click', () => {
                    const newUsername = document.getElementById('new-username').value;
                    if (newUsername.trim()) {
                        updateUsername(newUsername.trim());
                    }
                });
            }

            // Screenshot view buttons in profile
            document.querySelectorAll('[data-view-app]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appId = e.currentTarget.getAttribute('data-view-app');
                    const app = currentState.sharedApps.find(a => a.id === appId);
                    if (app) {
                        showScreenshotModal(app);
                    }
                });
            });
        } else if (currentView === 'login' || currentView === 'signup') {
            const authForm = document.getElementById('auth-form');
            if (authForm) {
                authForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('auth-email').value;
                    const password = document.getElementById('auth-password').value;
                    if (currentState.authMode === 'login') {
                        await handleSignIn(email, password);
                    } else {
                        await handleSignUp(email, password);
                    }
                };
            }

            const authModeToggleBtn = document.getElementById('auth-mode-toggle-btn'); 
            if (authModeToggleBtn) {
                authModeToggleBtn.addEventListener('click', () => {
                    const isLogin = currentState.authMode === 'login';
                    updateState({ authMode: isLogin ? 'signup' : 'login' });
                });
            }
        } else if (currentView === 'settings') {
            document.getElementById('light-mode-btn')?.addEventListener('click', () => {
                updateState({ theme: 'light' });
                showMessage(T('THEME_APPLIED'));
            });
            document.getElementById('dark-mode-btn')?.addEventListener('click', () => {
                updateState({ theme: 'dark' });
                showMessage(T('THEME_APPLIED'));
            });

            document.getElementById('language-options')?.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const lang = e.currentTarget.getAttribute('data-lang');
                    updateState({ language: lang });
                    showMessage(T('LANGUAGE_APPLIED'));
                });
            });
        } else if (currentView === 'admin') {
            document.querySelectorAll('[data-approve]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appId = e.currentTarget.getAttribute('data-approve');
                    const app = currentState.sharedApps.find(a => a.id === appId);
                    if (app) {
                        handleAppApproval(appId, !app.isApproved); 
                    }
                });
            });

            document.querySelectorAll('[data-delete]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appId = e.currentTarget.getAttribute('data-delete');
                    handleAppDeletion(appId);
                });
            });

            document.querySelectorAll('[data-edit]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appId = e.currentTarget.getAttribute('data-edit');
                    updateState({ editingAppId: appId });
                });
            });

            document.querySelectorAll('[data-cancel-edit]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    updateState({ editingAppId: null });
                });
            });
            
            document.querySelectorAll('.admin-edit-form').forEach(form => {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const appId = form.getAttribute('data-app-id');
                    const name = form.name.value;
                    const link = form.link.value;
                    const iconLink = form.iconLink.value;
                    const purpose = form.purpose.value;
                    await handleAppEdit(appId, name, link, iconLink, purpose);
                };
            });
        }
    }

    updateTheme(currentState.theme);

    onAuthStateChanged(auth, async (user) => {
        if (!currentState.isAuthReady) {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else if (!user) {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                try {
                    await signInAnonymously(auth);
                } catch (anonError) {
                    console.error("Anonymous Sign-in Failed:", anonError);
                }
            }

            const finalUser = auth.currentUser;
            const finalUserId = finalUser?.uid || 'anon-' + crypto.randomUUID();

            updateState({ 
                user: finalUser, 
                userId: finalUserId, 
                isAuthReady: true,
                view: finalUser && !finalUser.isAnonymous ? 'home' : 'login' 
            });

            startAppListener();

        } else {
            const finalUserId = user?.uid || 'anon-' + crypto.randomUUID();
            updateState({ 
                user: user, 
                userId: finalUserId,
                view: user && !user.isAnonymous ? currentState.view : 'login' 
            });
        }
    });

    renderApp(); 
</script>

</body>
</html>
